<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIZA ELITE | Cyber Command</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        
        /* Glass Panel Style */
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Glassmorphism & Neon) --- */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .chic-modal {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.95) 0%, rgba(10, 10, 20, 0.98) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.15), inset 0 0 20px rgba(0,0,0,0.5);
            border-radius: 24px;
            padding: 2rem;
            width: 95%;
            max-width: 480px;
            position: relative;
            overflow: hidden;
            animation: modalPop 0.3s ease-out forwards;
        }

        @keyframes modalPop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .chic-modal::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
        }

        .modal-title {
            font-size: 1.5rem; color: #fff; text-align: center; margin-bottom: 2rem; font-weight: 800;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .chic-label { display: block; color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.5rem; font-weight: 600; }
        
        .chic-input {
            width: 100%; background: rgba(30, 41, 59, 0.5); border: 1px solid #334155; color: #fff;
            padding: 12px 16px; border-radius: 12px; font-size: 1rem; transition: 0.3s; outline: none;
        }
        .chic-input:focus {
            border-color: #3b82f6; background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .btn-save-chic {
            flex: 2; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;
            padding: 14px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer;
            transition: 0.3s; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        .btn-save-chic:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5); }
        
        .btn-cancel-chic {
            flex: 1; background: transparent; border: 1px solid #ef4444; color: #ef4444;
            padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .btn-cancel-chic:hover { background: rgba(239, 68, 68, 0.1); }

        .hidden-elm { display: none !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="font-sans antialiased min-h-screen overflow-x-hidden selection:bg-blue-500 selection:text-white">

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-[url('https://cdn.pixabay.com/photo/2016/11/29/05/45/astronomy-1867616_960_720.jpg')] bg-cover bg-center">
        <div class="absolute inset-0 bg-dark-900/90 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md p-8 glass-panel rounded-2xl border-t border-blue-500/30 shadow-2xl text-center">
            <div class="w-20 h-20 mx-auto mb-6 bg-blue-600/20 rounded-full flex items-center justify-center border border-blue-500/50 shadow-lg shadow-blue-500/20">
                <i class="fas fa-fingerprint text-3xl text-blue-400"></i>
            </div>
            <h2 class="text-3xl font-bold text-white mb-2">GIZA ELITE</h2>
            <div class="space-y-4 mt-8">
                <input type="email" id="email" placeholder="ADMIN ID" class="chic-input text-center">
                <input type="password" id="password" placeholder="PIN CODE" class="chic-input text-center">
                <button onclick="handleLogin()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg transition-all">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden-elm flex h-screen overflow-hidden">
        
        <aside class="w-64 bg-dark-800 border-l border-slate-700 hidden md:flex flex-col z-10">
            <div class="p-6 border-b border-slate-700/50 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-code text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-white">GIZA DASH</h1>
                    <p class="text-xs text-slate-400">System Owner</p>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="switchMainTab('dashboard')" class="nav-tab active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white group transition-all text-right">
                    <i class="fas fa-tachometer-alt w-5 group-hover:text-blue-400"></i> <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </button>
                <button onclick="switchMainTab('tickets')" class="nav-tab w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white group transition-all text-right">
                    <i class="fas fa-envelope-open-text w-5 group-hover:text-green-400"></i> <span>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</span>
                </button>
                <button onclick="switchMainTab('team')" class="nav-tab w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white group transition-all text-right">
                    <i class="fas fa-users w-5 group-hover:text-purple-400"></i> <span>ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</span>
                </button>
            </nav>
            <div class="p-4 border-t border-slate-700/50">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition-all">
                    <i class="fas fa-power-off"></i> Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative overflow-hidden bg-dark-900">
            <header class="h-20 glass-panel border-b border-slate-700/50 flex items-center justify-between px-8 sticky top-0 z-20">
                <h2 class="text-2xl font-bold text-white" id="welcome-msg">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
                <div class="flex items-center gap-3">
                    <button onclick="openCreateModal('trial')" class="hidden sm:flex items-center gap-2 px-4 py-2 bg-orange-500/10 text-orange-400 border border-orange-500/30 rounded-lg hover:bg-orange-500 hover:text-white transition-all">
                        <i class="fas fa-bolt"></i> <span class="text-sm font-bold">ØªØ¬Ø±Ø¨Ø©</span>
                    </button>
                    <button onclick="openCreateModal('normal')" class="flex items-center gap-2 px-4 py-2 bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 rounded-lg hover:bg-emerald-500 hover:text-white transition-all">
                        <i class="fas fa-plus"></i> <span class="text-sm font-bold">ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll">
                
                <div id="dashboard-view" class="space-y-6">
                    <div id="stats-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 hidden-elm"></div>
                    
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-dark-800/50 p-4 rounded-2xl border border-slate-700/50">
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start sub-nav">
                            <button class="nav-btn active px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-blue-600 text-white" onclick="setView('active', this)">Ù…ÙØ¹Ù„</button>
                            <button class="nav-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all text-slate-400 hover:bg-slate-700" onclick="setView('trial', this)">ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
                            <button class="nav-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all text-slate-400 hover:bg-slate-700" onclick="setView('disabled', this)">Ù…Ø¹Ø·Ù„</button>
                            <button class="nav-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all text-slate-400 hover:bg-slate-700" onclick="setView('banned', this)">Ù…Ø­Ø¸ÙˆØ±</button>
                        </div>
                        <div class="relative w-full md:w-1/3">
                            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." class="w-full pl-4 pr-10 py-2 bg-dark-900 border border-slate-700 rounded-lg text-white focus:border-blue-500 outline-none text-sm">
                            <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        </div>
                    </div>

                    <div class="glass-panel rounded-2xl overflow-hidden overflow-x-auto">
                        <table class="w-full text-right border-collapse">
                            <thead class="bg-dark-800 text-slate-400 text-sm uppercase" id="table-head"></thead>
                            <tbody class="divide-y divide-slate-700/50 text-sm text-slate-300" id="table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tickets-view" class="hidden-elm space-y-6">
                    <div class="flex gap-4 border-b border-slate-700 pb-2 ticket-tabs">
                        <button class="ticket-tab-btn active text-blue-400 font-bold border-b-2 border-blue-400 pb-2 px-2" onclick="switchTicketTab('pending', this)">Ø¬Ø¯ÙŠØ¯ ğŸ”¥</button>
                        <button class="ticket-tab-btn text-slate-500 hover:text-slate-300 pb-2 px-2" onclick="switchTicketTab('replied', this)">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                    </div>
                    <div id="tickets-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>

                <div id="team-view" class="hidden-elm grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </main>
    </div>

    <div id="actionModal" class="fixed inset-0 z-50 hidden-elm flex items-center justify-center modal-overlay">
        <div class="chic-modal">
            <h2 id="modal-title" class="modal-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
            <input type="hidden" id="edit-mode-id">
            
            <div class="mb-4">
                <label class="chic-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                <input type="text" id="m-name" class="chic-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§...">
            </div>
            
            <div class="mb-4">
                <label class="chic-label">Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
                <select id="m-section" class="chic-input">
                    <option value="Ø£Ø¯Ø¨ÙŠ">Ø£Ø¯Ø¨ÙŠ</option>
                    <option value="Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option>
                    <option value="Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option>
                    <option value="Ø£Ø²Ù‡Ø±">Ø£Ø²Ù‡Ø±</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="chic-label">Ø§Ù„Ø³Ø¹Ø± (EGP)</label>
                <input type="number" id="m-price" class="chic-input" placeholder="0">
            </div>

            <div id="duration-section" class="mb-4">
                <label class="chic-label">Ø§Ù„Ù…Ø¯Ø©</label>
                <select id="m-duration" class="chic-input">
                    <option value="month">Ø´Ù‡Ø± ÙƒØ§Ù…Ù„</option>
                    <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø³Ø§Ø¹Ø©)</option>
                </select>
            </div>

            <div class="flex gap-3 mt-8">
                <button class="btn-save-chic" onclick="submitSave()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ’¾</button>
                <button class="btn-cancel-chic" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 z-50 hidden-elm flex items-center justify-center modal-overlay">
        <div class="chic-modal text-center">
            <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/50">
                <i class="fas fa-check text-2xl text-emerald-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­</h2>
            <div id="generated-code" class="bg-dark-900 p-4 rounded-xl border border-dashed border-slate-600 text-2xl font-mono text-emerald-400 my-6 select-all tracking-wider"></div>
            <button class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg" onclick="copyAndClose()">Ù†Ø³Ø® ÙˆØ¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="reply-modal" class="fixed inset-0 z-50 hidden-elm flex items-center justify-center modal-overlay">
        <div class="chic-modal">
            <h3 class="text-xl font-bold text-emerald-400 mb-2">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h3>
            <p id="reply-to-info" class="text-sm text-slate-400 mb-4"></p>
            <textarea id="reply-text" rows="4" class="chic-input mb-4" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..."></textarea>
            <div class="flex gap-3">
                <button onclick="sendReplySubmit()" class="btn-save-chic" id="submit-reply-btn">Ø¥Ø±Ø³Ø§Ù„ ğŸš€</button>
                <button onclick="closeReplyModal()" class="btn-cancel-chic">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
        const ADMIN_MAP = {
            "0zb8DE5GgeYobn0wMzaXiDAPbiO2": { name: "giza", label: "Ø§Ù„Ø¬ÙŠØ²Ø© (Ø§Ù„Ù…Ø§Ù„Ùƒ)", role: "owner" },
            "YFYNXb6sBEPkwfikuYBBVe6ggZN2": { name: "sara", label: "Ø³Ø§Ø±Ø© (Ù…Ø´Ø±ÙØ©)", role: "manager" },
            "Zh16pJVYpwZet02RGbRPgdwFfoE2": { name: "mahmoud", label: "Ù…Ø­Ù…ÙˆØ¯ (Ù…Ø´Ø±Ù)", role: "staff" },
            "5cY88LU42yfwjlOng4ik6aADm863": { name: "ahmed", label: "Ø£Ø­Ù…Ø¯ (Ù…Ø´Ø±Ù)", role: "staff" }
        };

        const SERVER_URL = "https://admey.vercel.app/api/admin"; 
        let currentUser = null;
        let dbData = { codes: [], blocked_devices: {} };
        let currentView = 'active'; 
        let currentScope = 'all';
        let allTickets = [];
        let currentTicketTab = 'pending';
        let currentReplyTicketId = null;

        // --- FIREBASE CONFIG ---
        const firebaseConfigMain = { 
            apiKey: "AIzaSyD7PB4meIc-r2ijKzheD7P868CfKdsVej0", 
            databaseURL: "https://full-mark1-default-rtdb.firebaseio.com" 
        };
        const mainApp = firebase.initializeApp(firebaseConfigMain); 
        const mainAuth = mainApp.auth();
        const db = mainApp.database(); // Direct DB access for updates

        const firebaseConfigTickets = {
            apiKey: "AIzaSyCm1yAULuM1D3ScjS9NUB2nCV_R-Y67QD4",
            databaseURL: "https://reply-full-default-rtdb.firebaseio.com"
        };
        const ticketApp = firebase.initializeApp(firebaseConfigTickets, "ticketsApp");
        const ticketDB = ticketApp.database();

        // --- AUTH ---
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                const res = await mainAuth.signInWithEmailAndPassword(email, pass);
                if (!ADMIN_MAP[res.user.uid]) { alert("Unauthorized"); mainAuth.signOut(); }
            } catch (e) { alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
        }

        mainAuth.onAuthStateChanged(user => {
            if (user && ADMIN_MAP[user.uid]) {
                currentUser = { ...ADMIN_MAP[user.uid], uid: user.uid };
                initDashboard();
            } else {
                document.getElementById('login-screen').classList.remove('hidden-elm');
                document.getElementById('admin-panel').classList.add('hidden-elm');
            }
        });

        function logout() { mainAuth.signOut(); }

        // --- DASHBOARD ---
        function initDashboard() {
            document.getElementById('login-screen').classList.add('hidden-elm');
            document.getElementById('admin-panel').classList.remove('hidden-elm');
            document.getElementById('welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.label}`;
            
            if (currentUser.role === 'owner') {
                document.getElementById('stats-area').classList.remove('hidden-elm');
            } else {
                currentScope = currentUser.name;
            }
            refreshData();
            if(currentUser.role === 'owner' || currentUser.role === 'manager') loadTicketsSystem();
        }

        async function refreshData() {
            try {
                // Reading data via API (as before)
                const res = await fetch(`${SERVER_URL}/dashboard-data?admin_uuid=${currentUser.uid}&target_admin=${currentScope}`);
                dbData = await res.json();
                renderTable();
                updateStats();
            } catch (e) { console.error(e); }
        }

        // --- CRUD ACTIONS (FIXED EDIT) ---
        async function submitSave() {
            const codeToEdit = document.getElementById('edit-mode-id').value;
            const name = document.getElementById('m-name').value;
            const section = document.getElementById('m-section').value;
            const price = document.getElementById('m-price').value;
            const duration = document.getElementById('m-duration').value;
            
            const btn = document.querySelector('.btn-save-chic');
            btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";

            try {
                if (codeToEdit) {
                    // === EDIT: DIRECT DB UPDATE (THE FIX) ===
                    const snapshot = await db.ref('codes').orderByChild('code').equalTo(codeToEdit).once('value');
                    if (snapshot.exists()) {
                        const key = Object.keys(snapshot.val())[0];
                        await db.ref('codes/' + key).update({
                            name: name,
                            section: section,
                            pricePaid: price
                        });
                        alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                        closeModal();
                        refreshData(); // Refresh table
                    } else {
                        alert("Ø®Ø·Ø£: Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
                    }
                } else {
                    // === CREATE: API CALL ===
                    const payload = {
                        name: name, section: section, price: parseFloat(price),
                        duration_type: duration, admin_uuid: currentUser.uid
                    };
                    const res = await fetch(`${SERVER_URL}/create-code`, { 
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) 
                    });
                    const data = await res.json();
                    closeModal();
                    document.getElementById('generated-code').innerText = data.code;
                    document.getElementById('successModal').classList.remove('hidden-elm');
                    refreshData();
                }
            } catch (e) { console.error(e); alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
            finally { btn.disabled = false; btn.innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ’¾"; }
        }

        function openCreateModal(mode) {
            document.getElementById('modal-title').innerText = mode === 'trial' ? "ÙƒÙˆØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠ" : "ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯";
            document.getElementById('edit-mode-id').value = "";
            document.getElementById('duration-section').classList.remove('hidden-elm');
            document.getElementById('m-name').value = "";
            document.getElementById('m-price').value = "0";
            document.getElementById('m-duration').value = mode === 'trial' ? "trial" : "month";
            document.getElementById('actionModal').classList.remove('hidden-elm');
        }

        function openEditModal(code) {
            const item = dbData.codes.find(c => c.code === code);
            if (!item) return;
            document.getElementById('modal-title').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            document.getElementById('edit-mode-id').value = code;
            document.getElementById('m-name').value = item.name;
            document.getElementById('m-section').value = item.section || 'Ø¹Ø§Ù…';
            document.getElementById('m-price').value = item.pricePaid;
            document.getElementById('duration-section').classList.add('hidden-elm');
            document.getElementById('actionModal').classList.remove('hidden-elm');
        }

        async function quickAction(code, action) {
            if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ")) return;
            await fetch(`${SERVER_URL}/take-action`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code, action, admin_uuid: currentUser.uid }) });
            refreshData();
        }

        // --- VIEWS ---
        function updateStats() {
            if(currentUser.role !== 'owner') return;
            const area = document.getElementById('stats-area');
            const active = dbData.codes.filter(c => c.state === 'active').length;
            const total = dbData.codes.length;
            
            area.innerHTML = `
                <div class="glass-panel p-4 rounded-xl flex justify-between items-center">
                    <div><p class="text-slate-400 text-xs">Ù†Ø´Ø·</p><h3 class="text-2xl font-bold text-white">${active}</h3></div>
                    <div class="w-10 h-10 bg-blue-600/20 text-blue-400 rounded-lg flex items-center justify-center"><i class="fas fa-user-check"></i></div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex justify-between items-center">
                    <div><p class="text-slate-400 text-xs">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p><h3 class="text-2xl font-bold text-white">${total}</h3></div>
                    <div class="w-10 h-10 bg-purple-600/20 text-purple-400 rounded-lg flex items-center justify-center"><i class="fas fa-database"></i></div>
                </div>
            `;
        }

        function renderTable() {
            const head = document.getElementById('table-head');
            const body = document.getElementById('table-body');
            body.innerHTML = '';
            
            if(currentView === 'banned') {
                head.innerHTML = `<tr><th class="p-4">Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th class="p-4">Ø§Ù„Ø³Ø¨Ø¨</th><th class="p-4">Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
                Object.values(dbData.blocked_devices || {}).forEach(d => {
                    body.innerHTML += `<tr><td class="p-4 font-mono text-red-400">${d.deviceId}</td><td class="p-4 text-slate-400">${d.reason}</td><td class="p-4"><button class="text-blue-400" onclick="quickAction('${d.deviceId}', 'unban_device')">ÙÙƒ Ø§Ù„Ø­Ø¸Ø±</button></td></tr>`;
                });
                return;
            }

            head.innerHTML = `<tr><th class="p-4">Ø§Ù„Ø·Ø§Ù„Ø¨</th><th class="p-4">Ø§Ù„ÙƒÙˆØ¯</th><th class="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-4">Ø§Ù„Ø³Ø¹Ø±</th><th class="p-4 text-center">Ø£Ø¯ÙˆØ§Øª</th></tr>`;
            let list = currentView === 'trial' ? dbData.codes.filter(c => c.isTrial) : dbData.codes.filter(c => c.state === currentView);
            if (currentUser.role !== 'owner') list = list.filter(c => c.addedByAdmin === currentUser.name);

            list.forEach(item => {
                const badge = item.isTrial ? '<span class="text-orange-400 text-[10px] border border-orange-500/30 px-1 rounded ml-1">TRIAL</span>' : '';
                body.innerHTML += `
                    <tr class="hover:bg-slate-800/30 transition-colors">
                        <td class="p-4">
                            <div class="font-bold text-white">${item.name} ${badge}</div>
                            <div class="text-xs text-slate-500">${item.section}</div>
                        </td>
                        <td class="p-4 font-mono text-blue-400">${item.code}</td>
                        <td class="p-4">${formatDuration(item)}</td>
                        <td class="p-4 font-bold text-emerald-400">${item.pricePaid}</td>
                        <td class="p-4 flex justify-center gap-2">
                            <button onclick="copyText('${item.code}')" class="w-8 h-8 rounded-lg bg-slate-700 hover:bg-slate-600 text-white flex items-center justify-center"><i class="fas fa-copy text-xs"></i></button>
                            <button onclick="openEditModal('${item.code}')" class="w-8 h-8 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white flex items-center justify-center"><i class="fas fa-edit text-xs"></i></button>
                            <button onclick="quickAction('${item.code}', 'delete')" class="w-8 h-8 rounded-lg bg-red-600 hover:bg-red-500 text-white flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // --- TICKETS ---
        function loadTicketsSystem() {
            ticketDB.ref('support_tickets').on('value', (s) => {
                const d = s.val();
                allTickets = d ? Object.keys(d).map(k => ({id:k, ...d[k]})).sort((a,b)=>b.timestamp-a.timestamp) : [];
                if(!document.getElementById('tickets-view').classList.contains('hidden-elm')) renderTicketsGrid();
            });
        }
        function renderTicketsGrid() {
            const c = document.getElementById('tickets-container'); c.innerHTML = '';
            const f = allTickets.filter(t => currentTicketTab === 'pending' ? !t.isReplied : t.isReplied);
            if(f.length===0) return c.innerHTML = `<p class="col-span-full text-center text-slate-500 py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p>`;
            f.forEach(t => {
                c.innerHTML += `
                    <div class="glass-panel p-5 rounded-xl border border-slate-700/50 hover:border-blue-500/30 transition-all">
                        <div class="flex justify-between text-xs text-slate-500 mb-2"><span>${t.studentName||'?'}</span><span>${new Date(t.timestamp).toLocaleDateString()}</span></div>
                        <h4 class="text-white font-bold mb-2">${t.subject}</h4>
                        <div class="bg-dark-900/50 p-3 rounded text-sm text-slate-300 mb-3 border border-slate-700/50">${t.message}</div>
                        ${t.isReplied ? `<div class="text-emerald-400 text-xs mb-2">Ø§Ù„Ø±Ø¯: ${t.adminReply}</div>` : 
                        `<button onclick="openReplyModal('${t.id}', '${t.studentName}')" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded font-bold text-sm">Ø±Ø¯ Ø§Ù„Ø¢Ù†</button>`}
                    </div>`;
            });
        }
        function openReplyModal(id, name) { currentReplyTicketId=id; document.getElementById('reply-to-info').innerText=`Ø¥Ù„Ù‰: ${name}`; document.getElementById('reply-modal').classList.remove('hidden-elm'); }
        function sendReplySubmit() {
            const txt = document.getElementById('reply-text').value; if(!txt) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯");
            ticketDB.ref('support_tickets/'+currentReplyTicketId).update({isReplied:true, adminReply:txt, replyDate:firebase.database.ServerValue.TIMESTAMP})
            .then(()=>{ document.getElementById('reply-modal').classList.add('hidden-elm'); alert("ØªÙ… Ø§Ù„Ø±Ø¯"); });
        }

        // --- HELPERS ---
        function formatDuration(i) {
            if(i.state!=='active') return `<span class="text-slate-500">Ù…Ù†ØªÙ‡ÙŠ</span>`;
            const r = i.expiry - Date.now();
            if(r<=0) return `<span class="text-red-400">Ø§Ù†ØªÙ‡Ù‰</span>`;
            return i.isTrial ? `<span class="text-orange-400">${Math.floor(r/60000)} Ø¯Ù‚ÙŠÙ‚Ø©</span>` : `<span class="text-emerald-400">${Math.ceil(r/86400000)} ÙŠÙˆÙ…</span>`;
        }
        function switchMainTab(v) { 
            ['dashboard','tickets','team'].forEach(t=>document.getElementById(t+'-view').classList.add('hidden-elm'));
            document.getElementById(v+'-view').classList.remove('hidden-elm');
            document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active','text-white'));
            event.currentTarget.classList.add('active','text-white');
            if(v==='tickets') renderTicketsGrid();
        }
        function switchTicketTab(t, b) { currentTicketTab=t; document.querySelectorAll('.ticket-tab-btn').forEach(btn=>btn.classList.remove('active','text-blue-400','border-b-2')); b.classList.add('active','text-blue-400','border-b-2'); renderTicketsGrid(); }
        function setView(v, b) { currentView=v; document.querySelectorAll('.sub-nav .nav-btn').forEach(btn=>btn.classList.remove('active','bg-blue-600','text-white')); b.classList.add('active','bg-blue-600','text-white'); renderTable(); }
        function filterTable() { const v=document.getElementById("searchInput").value.toLowerCase(); document.querySelectorAll("#table-body tr").forEach(r=>r.style.display=r.innerText.toLowerCase().includes(v)?"":"none"); }
        function copyText(t) { navigator.clipboard.writeText(t); }
        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.add('hidden-elm')); }
        function closeReplyModal() { document.getElementById('reply-modal').classList.add('hidden-elm'); }
        function copyAndClose() { copyText(document.getElementById('generated-code').innerText); closeModal(); }
    </script>
</body>
</html>
