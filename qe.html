<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GIZA ELITE | System</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #000000;
            --panel: #0a0a0a;
            --border: #1a1a1a;
            --primary: #00ff41; /* Matrix Green */
            --primary-dim: rgba(0, 255, 65, 0.1);
            --text: #e0e0e0;
            --text-muted: #666;
            --danger: #ff003c;
            --warning: #f1c40f;
            --info: #00bfff;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            font-family: 'Cairo', sans-serif;
            background-image: radial-gradient(#111 1px, transparent 1px);
            background-size: 20px 20px;
            overflow-x: hidden;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 2px; }

        /* --- Layout & Typography --- */
        h1, h2, h3 { margin: 0; font-weight: 700; }
        .fira { font-family: 'Fira Code', monospace; }

        /* --- Login Screen (Simplified for Speed) --- */
        #login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; }
        .login-box { 
            width: 100%; max-width: 380px; 
            background: var(--panel); 
            border: 1px solid var(--primary); 
            padding: 40px 30px; 
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }
        
        input, select { 
            width: 100%; padding: 14px; margin: 8px 0; 
            background: #000; border: 1px solid #333; 
            color: var(--primary); font-family: 'Fira Code'; font-size: 1rem; 
            border-radius: 4px; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); }

        /* --- Buttons --- */
        .btn { 
            padding: 12px 20px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; 
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
            font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary); color: #000; width: 100%; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-action { padding: 8px 12px; font-size: 0.8rem; background: #222; color: #fff; border: 1px solid #333; width: auto; }
        .btn-delete { background: rgba(255,0,60,0.1); color: var(--danger); border-color: var(--danger); }
        
        /* --- Admin Panel --- */
        #admin-panel { display: none; padding: 15px; max-width: 1600px; margin: auto; }

        /* Mobile Header */
        .header { 
            display: flex; flex-direction: column; gap: 15px; 
            background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; 
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .user-info h3 { color: #fff; font-size: 1.2rem; }
        .user-role { color: var(--primary); font-size: 0.85rem; letter-spacing: 1px; }

        /* Navigation Tabs (Scrollable on Mobile) */
        .tabs-container { 
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; 
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        .nav-tab { 
            background: transparent; color: #666; padding: 10px 15px; border: none; cursor: pointer; font-size: 1rem; 
            border-bottom: 2px solid transparent; flex-shrink: 0;
        }
        .nav-tab.active { color: var(--primary); border-color: var(--primary); font-weight: bold; }

        /* --- Dashboard Charts --- */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .chart-card { background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); height: 250px; position: relative; }
        
        /* --- Stats Row --- */
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--panel); padding: 15px; border-radius: 8px; border-right: 3px solid var(--primary); text-align: center; }
        .stat-num { font-size: 1.8rem; color: #fff; font-weight: bold; }
        .stat-label { color: var(--text-muted); font-size: 0.8rem; }

        /* --- Filter Buttons --- */
        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .filter-btn { 
            background: #111; border: 1px solid #333; color: #888; padding: 6px 16px; 
            border-radius: 20px; white-space: nowrap; font-size: 0.85rem; cursor: pointer;
        }
        .filter-btn.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }

        /* --- Responsive Table (The Magic Part) --- */
        .table-wrapper { background: var(--panel); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; padding: 15px; background: #0f0f0f; color: var(--primary); font-size: 0.85rem; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid #1a1a1a; color: #ccc; font-size: 0.9rem; }

        /* Mobile View for Table */
        @media (max-width: 768px) {
            .header { align-items: stretch; }
            .header-top { margin-bottom: 10px; }
            
            thead { display: none; } /* Hide headers */
            tr { display: block; border-bottom: 1px solid var(--border); padding: 15px; position: relative; }
            td { 
                display: flex; justify-content: space-between; align-items: center; 
                padding: 5px 0; border: none; 
            }
            /* Add labels before data */
            td::before { content: attr(data-label); color: var(--text-muted); font-size: 0.8rem; }
            
            /* Special styling for the Code (First cell) */
            td:first-child { 
                background: #111; padding: 10px; border-radius: 6px; margin-bottom: 10px; 
                justify-content: center; font-weight: bold; color: var(--primary); letter-spacing: 1px;
            }
            td:first-child::before { display: none; }

            /* Action Buttons Row */
            td:last-child { margin-top: 10px; justify-content: center; gap: 5px; flex-wrap: wrap; }
        }

        /* --- Actions --- */
        .action-btn { 
            width: 35px; height: 35px; border-radius: 6px; border: none; 
            display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer;
        }
        
        /* --- Modals --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: #111; width: 100%; max-width: 450px; padding: 25px; border-radius: 12px; border: 1px solid var(--primary); }

        /* --- Admin Card Grid (Team) --- */
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .admin-card { background: var(--panel); border: 1px solid var(--border); padding: 20px; border-radius: 8px; text-align: center; }
        .admin-card h3 { font-size: 1rem; margin-top: 10px; color: #fff; }
        .stat-pill { background: #1a1a1a; padding: 5px 10px; border-radius: 4px; color: var(--primary); font-size: 0.8rem; margin-top: 10px; display: inline-block; }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <i class="fas fa-fingerprint fa-3x" style="color: var(--primary); margin-bottom: 15px;"></i>
            <h2 style="color: #fff; margin-bottom: 5px;">SYSTEM LOGIN</h2>
            <p style="color: #666; font-size: 0.8rem; margin-bottom: 20px;">GIZA ELITE CONTROL</p>
            <input type="email" id="email" placeholder="ADMIN ID">
            <input type="password" id="password" placeholder="PIN CODE">
            <button class="btn btn-primary" onclick="handleLogin()" style="margin-top: 15px;">LOGIN <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="admin-panel">
        <div class="header">
            <div class="header-top">
                <div class="user-info">
                    <h3 id="welcome-msg">WELCOME</h3>
                    <div id="role-label" class="user-role">...</div>
                </div>
                <button class="btn btn-action btn-delete" onclick="logout()"><i class="fas fa-power-off"></i></button>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal()"><i class="fas fa-plus"></i> كود جديد</button>
        </div>

        <div class="tabs-container">
            <button class="nav-tab active" onclick="switchMainTab('dashboard')">التحكم</button>
            <button class="nav-tab" onclick="switchMainTab('tickets')">الرسايل</button>
            <button class="nav-tab" onclick="switchMainTab('team')">الفريق</button>
        </div>

        <div id="dashboard-view">
            <div id="stats-area" class="stats-row" style="display:none;"></div>

            <div class="charts-grid" id="charts-area">
                <div class="chart-card"><canvas id="usersChart"></canvas></div>
                <div class="chart-card"><canvas id="financeChart"></canvas></div>
            </div>

            <div class="filter-scroll">
                <button class="filter-btn active" onclick="setView('active', this)">نشط</button>
                <button class="filter-btn" onclick="setView('trial', this)">تجريبي</button>
                <button class="filter-btn" onclick="setView('expired', this)">منتهي</button>
                <button class="filter-btn" onclick="setView('banned', this)">محظور</button>
            </div>

            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="بحث سريع..." style="margin-bottom: 15px;">

            <div class="table-wrapper">
                <table id="main-table">
                    <thead id="table-head"></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="team-view" class="team-grid" style="display:none;"></div>
        
        <div id="tickets-view" style="display:none;">
             <div class="stats-row">
                <div class="stat-card"><div class="stat-num" style="color:#ff003c" id="p-count">0</div><div class="stat-label">انتظار</div></div>
                <div class="stat-card"><div class="stat-num" style="color:#00ff41" id="r-count">0</div><div class="stat-label">تم الرد</div></div>
            </div>
            <div id="tickets-container" style="display:grid; gap:15px;"></div>
        </div>
    </div>

    <div id="actionModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary); margin-top:0">بيانات الطالب</h3>
            <input type="hidden" id="edit-mode-id">
            <input type="text" id="m-name" placeholder="الاسم">
            <select id="m-section">
                <option value="عام">عام</option>
                <option value="علمي">علمي</option>
                <option value="أدبي">أدبي</option>
            </select>
            <input type="number" id="m-price" placeholder="السعر">
            <select id="m-duration">
                <option value="month">شهر</option>
                <option value="trial">تجربة</option>
            </select>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" onclick="submitSave()">حفظ</button>
                <button class="btn btn-action" onclick="closeModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const ADMIN_MAP = {
            "0zb8DE5GgeYobn0wMzaXiDAPbiO2": { name: "giza", label: "Eng. Giza", role: "owner" },
            "YFYNXb6sBEPkwfikuYBBVe6ggZN2": { name: "sara", label: "Eng. Sara", role: "manager" },
            "Zh16pJVYpwZet02RGbRPgdwFfoE2": { name: "mahmoud", label: "Eng. Mahmoud", role: "staff" },
            "5cY88LU42yfwjlOng4ik6aADm863": { name: "ahmed", label: "Eng. Ahmed", role: "staff" }
        };
        const SERVER_URL = "https://admey.vercel.app/api/admin"; 

        // Firebase Init
        const mainApp = firebase.initializeApp({ apiKey: "AIzaSyD7PB4meIc-r2ijKzheD7P868CfKdsVej0", databaseURL: "https://full-mark1-default-rtdb.firebaseio.com" });
        const ticketApp = firebase.initializeApp({ apiKey: "AIzaSyCm1yAULuM1D3ScjS9NUB2nCV_R-Y67QD4", databaseURL: "https://reply-full-default-rtdb.firebaseio.com" }, "tickets");

        let currentUser = null;
        let dbData = { codes: [] };
        let charts = {};
        let currentView = 'active';

        // --- Auth & Init ---
        mainApp.auth().onAuthStateChanged(user => {
            if(user && ADMIN_MAP[user.uid]) {
                currentUser = { ...ADMIN_MAP[user.uid], uid: user.uid };
                initApp();
            } else {
                showLogin();
            }
        });

        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('admin-panel').style.display = 'none';
        }

        async function handleLogin() {
            try {
                const em = document.getElementById('email').value;
                const pw = document.getElementById('password').value;
                await mainApp.auth().signInWithEmailAndPassword(em, pw);
            } catch(e) { alert("بيانات خطأ"); }
        }

        function logout() { mainApp.auth().signOut(); }

        function initApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('welcome-msg').innerText = currentUser.label;
            document.getElementById('role-label').innerText = currentUser.role.toUpperCase();
            
            if(currentUser.role === 'owner') {
                document.getElementById('stats-area').style.display = 'grid';
            } else {
                document.getElementById('charts-area').style.display = 'none';
            }
            refreshData();
        }

        // --- Data Handling ---
        async function refreshData() {
            try {
                // Fetch data
                const res = await fetch(`${SERVER_URL}/dashboard-data?admin_uuid=${currentUser.uid}&target_admin=all`);
                dbData = await res.json();
                
                // Render
                renderTable();
                
                // Stats (Owner only)
                if(currentUser.role === 'owner') {
                    updateCharts();
                    updateStatsBar();
                }
            } catch(e) { console.log(e); }
        }

        // --- Fixed Chart Logic ---
        function updateCharts() {
            const ctx1 = document.getElementById('usersChart');
            const ctx2 = document.getElementById('financeChart');
            if(!ctx1 || !ctx2) return;

            // Destroy old to prevent overlay
            if(charts.users) charts.users.destroy();
            if(charts.finance) charts.finance.destroy();

            // Calcs
            const active = dbData.codes.filter(c => c.state === 'active').length;
            const expired = dbData.codes.filter(c => c.state === 'expired').length;
            const revenue = dbData.codes.reduce((a, b) => a + (parseFloat(b.pricePaid)||0), 0);

            // Chart Defaults
            Chart.defaults.color = '#666';
            Chart.defaults.font.family = 'Cairo';

            charts.users = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Expired'],
                    datasets: [{ data: [active, expired], backgroundColor: ['#00ff41', '#333'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            charts.finance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Revenue'],
                    datasets: [{ label: 'EGP', data: [revenue], backgroundColor: '#00bfff' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#222' } } } }
            });
        }

        function updateStatsBar() {
            const count = dbData.codes.length;
            const active = dbData.codes.filter(c => c.state === 'active').length;
            document.getElementById('stats-area').innerHTML = `
                <div class="stat-card"><div class="stat-num">${count}</div><div class="stat-label">الكل</div></div>
                <div class="stat-card"><div class="stat-num" style="color:var(--primary)">${active}</div><div class="stat-label">نشط</div></div>
            `;
        }

        // --- Table Rendering (Responsive) ---
        function renderTable() {
            const head = document.getElementById('table-head');
            const body = document.getElementById('table-body');
            body.innerHTML = '';
            
            // Setup Header
            if (currentView === 'banned') {
                head.innerHTML = `<tr><th>Device ID</th><th>By</th><th>Unlock</th></tr>`;
            } else {
                head.innerHTML = `<tr><th>Code</th><th>Name</th><th>Device</th><th>Price</th><th>Actions</th></tr>`;
            }

            // Filter
            let list = currentView === 'trial' ? dbData.codes.filter(c => c.isTrial) : 
                       currentView === 'banned' ? [] : dbData.codes.filter(c => c.state === currentView);
            
            if (currentView === 'banned') list = Object.values(dbData.blocked_devices || {});

            list.forEach(item => {
                let row = '';
                if(currentView === 'banned') {
                    row = `
                    <tr>
                        <td data-label="Device">${item.deviceId}</td>
                        <td data-label="By">${item.blockedBy}</td>
                        <td data-label="Action"><button class="btn btn-action" onclick="unban('${item.deviceId}')">فك</button></td>
                    </tr>`;
                } else {
                    const dev = item.deviceId ? `<span class="fira" style="color:#00bfff">${item.deviceId}</span>` : '---';
                    row = `
                    <tr>
                        <td class="fira">${item.code}</td>
                        <td data-label="الاسم"><b>${item.name}</b><br><small style="color:#666">${item.section}</small></td>
                        <td data-label="الجهاز">${dev}</td>
                        <td data-label="السعر" style="color:var(--primary)">${item.pricePaid}</td>
                        <td data-label="تحكم">
                            <button class="action-btn" style="background:#00bfff" onclick="copy('${item.code}')"><i class="fas fa-copy"></i></button>
                            <button class="action-btn" style="background:#e67e22" onclick="action('${item.code}', 'eject_device')"><i class="fas fa-sign-out-alt"></i></button>
                            <button class="action-btn" style="background:#ff003c" onclick="action('${item.code}', 'delete')"><i class="fas fa-trash"></i></button>
                            <button class="action-btn" style="background:#2ecc71" onclick="openEdit('${item.code}')"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>`;
                }
                body.insertAdjacentHTML('beforeend', row);
            });
        }

        // --- Helpers ---
        function switchMainTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            ['dashboard-view', 'tickets-view', 'team-view'].forEach(v => document.getElementById(v).style.display = 'none');
            document.getElementById(tab + '-view').style.display = (tab === 'team' || tab === 'tickets') ? 'grid' : 'block';
            
            if(tab === 'team') renderTeam();
        }

        function renderTeam() {
            const container = document.getElementById('team-view');
            container.innerHTML = Object.values(ADMIN_MAP).map(adm => {
                const count = dbData.codes.filter(c => c.addedByAdmin === adm.name).length;
                return `
                <div class="admin-card">
                    <i class="fas fa-user-astronaut fa-2x" style="color:var(--primary)"></i>
                    <h3>${adm.label}</h3>
                    <div class="stat-pill">${count} Codes</div>
                </div>`;
            }).join('');
        }

        function setView(v, btn) {
            currentView = v;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTable();
        }

        async function action(c, a) {
            if(!confirm("تأكيد؟")) return;
            await fetch(`${SERVER_URL}/take-action`, { method: 'POST', body: JSON.stringify({code:c, action:a, admin_uuid:currentUser.uid}) });
            refreshData();
        }
        
        // Modals & Copy
        function openCreateModal() { document.getElementById('actionModal').style.display = 'flex'; }
        function openEdit(c) { 
            document.getElementById('edit-mode-id').value = c; 
            document.getElementById('actionModal').style.display = 'flex'; 
        }
        function closeModal() { document.getElementById('actionModal').style.display = 'none'; }
        async function submitSave() {
             // نفس كود الحفظ السابق الخاص بك
             alert("تم الحفظ (محاكاة)");
             closeModal();
        }
        function copy(t) { navigator.clipboard.writeText(t); }

        // Filter Table
        function filterTable() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('#table-body tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        }
    </script>
</body>
</html>
