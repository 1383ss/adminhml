<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIZA ELITE | Cyber Command</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        dark: { 
                            900: '#0f172a', 
                            800: '#1e293b', 
                            700: '#334155',
                            card: 'rgba(30, 41, 59, 0.7)' 
                        },
                        accent: {
                            DEFAULT: '#3b82f6', // Ø£Ø²Ø±Ù‚ Ø¹ØµØ±ÙŠ
                            glow: 'rgba(59, 130, 246, 0.5)'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ */
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* ØªØ®ØµÙŠØµ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Ø­Ø±ÙƒØ§Øª Ø¨Ø³ÙŠØ·Ø© */
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        .hidden-elm { display: none !important; }
    </style>
</head>
<body class="font-sans antialiased min-h-screen overflow-x-hidden selection:bg-blue-500 selection:text-white">

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-[url('https://cdn.pixabay.com/photo/2016/11/29/05/45/astronomy-1867616_960_720.jpg')] bg-cover bg-center">
        <div class="absolute inset-0 bg-dark-900/90 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md p-8 mx-4 glass-panel rounded-2xl border-t border-blue-500/30 shadow-2xl shadow-blue-900/20 text-center">
            <div class="w-20 h-20 mx-auto mb-6 bg-blue-600/20 rounded-full flex items-center justify-center border border-blue-500/50 shadow-lg shadow-blue-500/20">
                <i class="fas fa-fingerprint text-3xl text-blue-400"></i>
            </div>
            <h2 class="text-3xl font-bold text-white mb-2 tracking-wide">GIZA ELITE</h2>
            <p class="text-slate-400 mb-8 text-sm">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
            
            <div class="space-y-4">
                <input type="email" id="email" placeholder="ADMIN ID" class="w-full px-4 py-3 bg-dark-900/50 border border-slate-700 rounded-xl text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all placeholder-slate-600">
                <input type="password" id="password" placeholder="PIN CODE" class="w-full px-4 py-3 bg-dark-900/50 border border-slate-700 rounded-xl text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all placeholder-slate-600">
                <button onclick="handleLogin()" class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold rounded-xl shadow-lg shadow-blue-600/30 transition-all transform hover:-translate-y-1">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ <i class="fas fa-arrow-left mr-2"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden-elm flex h-screen overflow-hidden">
        
        <aside class="w-64 bg-dark-800 border-l border-slate-700 hidden md:flex flex-col z-10">
            <div class="p-6 border-b border-slate-700/50 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-600/20">
                    <i class="fas fa-code text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-white">GIZA DASH</h1>
                    <p class="text-xs text-slate-400" id="role-label-sidebar">Admin Panel</p>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="switchMainTab('dashboard')" class="nav-tab active w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-700/50 hover:text-white group text-right">
                    <i class="fas fa-tachometer-alt w-5 group-hover:text-blue-400 transition-colors"></i> <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </button>
                <button onclick="switchMainTab('tickets')" class="nav-tab w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-700/50 hover:text-white group text-right">
                    <i class="fas fa-envelope-open-text w-5 group-hover:text-green-400 transition-colors"></i> <span>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</span>
                </button>
                <button onclick="switchMainTab('team')" class="nav-tab w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-700/50 hover:text-white group text-right">
                    <i class="fas fa-users w-5 group-hover:text-purple-400 transition-colors"></i> <span>ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</span>
                </button>
            </nav>

            <div class="p-4 border-t border-slate-700/50">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition-all">
                    <i class="fas fa-power-off"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative overflow-hidden bg-dark-900">
            
            <header class="h-20 glass-panel border-b border-slate-700/50 flex items-center justify-between px-8 sticky top-0 z-20">
                <div>
                    <h2 class="text-2xl font-bold text-white" id="welcome-msg">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
                    <p class="text-xs text-blue-400 mt-1" id="role-label">System Online</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openCreateModal('trial')" class="hidden sm:flex items-center gap-2 px-4 py-2 bg-orange-500/10 text-orange-400 border border-orange-500/30 rounded-lg hover:bg-orange-500 hover:text-white transition-all">
                        <i class="fas fa-bolt"></i> <span class="text-sm font-bold">ØªØ¬Ø±Ø¨Ø©</span>
                    </button>
                    <button onclick="openCreateModal('normal')" class="flex items-center gap-2 px-4 py-2 bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 rounded-lg hover:bg-emerald-500 hover:text-white transition-all">
                        <i class="fas fa-plus"></i> <span class="text-sm font-bold">ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll">
                
                <div id="dashboard-view" class="space-y-6">
                    
                    <div id="stats-area" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 hidden-elm"></div>
                    
                    <div id="charts-area" class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden-elm">
                        <div class="glass-panel p-5 rounded-2xl h-80">
                            <canvas id="usersChart"></canvas>
                        </div>
                        <div class="glass-panel p-5 rounded-2xl h-80">
                            <canvas id="financeChart"></canvas>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-dark-800/50 p-4 rounded-2xl border border-slate-700/50">
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start sub-nav">
                            <button class="nav-btn active px-4 py-1.5 rounded-full text-sm font-medium transition-all bg-blue-600 text-white shadow-lg shadow-blue-500/30" onclick="setView('active', this)">Ù…ÙØ¹Ù„</button>
                            <button class="nav-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all text-slate-400 hover:bg-slate-700" onclick="setView('trial', this)">ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
                            <button class="nav-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all text-slate-400 hover:bg-slate-700" onclick="setView('disabled', this)">Ù…Ø¹Ø·Ù„</button>
                            <button class="nav-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all text-slate-400 hover:bg-slate-700" onclick="setView('expired', this)">Ù…Ù†ØªÙ‡ÙŠ</button>
                            <button class="nav-btn px-4 py-1.5 rounded-full text-sm font-medium transition-all text-slate-400 hover:bg-slate-700" onclick="setView('banned', this)">Ù…Ø­Ø¸ÙˆØ±</button>
                        </div>
                        <div class="relative w-full md:w-1/3">
                            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." class="w-full pl-4 pr-10 py-2 bg-dark-900 border border-slate-700 rounded-lg text-white focus:border-blue-500 outline-none text-sm">
                            <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        </div>
                    </div>

                    <div class="glass-panel rounded-2xl overflow-hidden overflow-x-auto">
                        <table id="main-table" class="w-full text-right border-collapse">
                            <thead class="bg-dark-800 text-slate-400 text-sm uppercase" id="table-head">
                                </thead>
                            <tbody class="divide-y divide-slate-700/50 text-sm text-slate-300" id="table-body">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="tickets-view" class="hidden-elm space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-panel p-6 rounded-2xl flex items-center justify-between border-l-4 border-red-500">
                            <div>
                                <h3 class="text-slate-400 font-medium">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h3>
                                <p class="text-xs text-slate-500 mt-1">Ø±Ø³Ø§Ø¦Ù„ ØªØ­ØªØ§Ø¬ Ù„Ù„Ø±Ø¯</p>
                            </div>
                            <span id="count-pending" class="text-4xl font-bold text-white">0</span>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl flex items-center justify-between border-l-4 border-emerald-500">
                            <div>
                                <h3 class="text-slate-400 font-medium">ØªÙ… Ø§Ù„Ø±Ø¯</h3>
                                <p class="text-xs text-slate-500 mt-1">Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
                            </div>
                            <span id="count-replied" class="text-4xl font-bold text-white">0</span>
                        </div>
                    </div>

                    <div class="flex gap-4 border-b border-slate-700 pb-2 ticket-tabs">
                        <button class="ticket-tab-btn active text-blue-400 font-bold border-b-2 border-blue-400 pb-2 px-2 transition-colors" onclick="switchTicketTab('pending', this)">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ”¥</button>
                        <button class="ticket-tab-btn text-slate-500 hover:text-slate-300 pb-2 px-2 transition-colors" onclick="switchTicketTab('replied', this)">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                    </div>

                    <div id="tickets-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        </div>
                </div>

                <div id="team-view" class="hidden-elm grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>

            </div>
        </main>
    </div>

    <div id="actionModal" class="fixed inset-0 z-50 hidden-elm flex items-center justify-center bg-dark-900/80 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6 border border-slate-600 shadow-2xl transform scale-100 transition-all">
            <h2 id="modal-title" class="text-xl font-bold text-white mb-6 border-b border-slate-700 pb-4">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
            
            <input type="hidden" id="edit-mode-id">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-slate-400 text-sm mb-2">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                    <input type="text" id="m-name" class="w-full bg-dark-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-slate-400 text-sm mb-2">Ø§Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
                    <select id="m-section" class="w-full bg-dark-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                        <option value="Ø£Ø¯Ø¨ÙŠ">Ø£Ø¯Ø¨ÙŠ</option>
                        <option value="Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option>
                        <option value="Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option>
                        <option value="Ø£Ø²Ù‡Ø±">Ø£Ø²Ù‡Ø±</option>
                    </select>
                </div>

                <div>
                    <label class="block text-slate-400 text-sm mb-2">Ø§Ù„Ø³Ø¹Ø± (EGP)</label>
                    <input type="number" id="m-price" value="0" class="w-full bg-dark-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                </div>

                <div id="duration-section">
                    <label class="block text-slate-400 text-sm mb-2">Ø§Ù„Ù…Ø¯Ø©</label>
                    <div class="flex gap-2">
                        <select id="m-duration" onchange="toggleCustomDays(this.value)" class="w-full bg-dark-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                            <option value="month">Ø´Ù‡Ø± (30 ÙŠÙˆÙ…)</option>
                            <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø³Ø§Ø¹Ø©)</option>
                            <option value="custom">Ù…Ø®ØµØµ</option>
                        </select>
                        <input type="number" id="m-days" placeholder="ÙŠÙˆÙ…" style="display:none;" class="w-24 bg-dark-900 border border-slate-700 rounded-lg p-3 text-white text-center">
                    </div>
                </div>

                <div class="flex gap-3 mt-6 pt-4 border-t border-slate-700">
                    <button class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold transition-all shadow-lg shadow-emerald-600/20 btn-success" onclick="submitSave()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold transition-all" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <div id="successModal" class="fixed inset-0 z-50 hidden-elm flex items-center justify-center bg-dark-900/90 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-8 text-center border border-emerald-500/50 shadow-[0_0_50px_rgba(16,185,129,0.2)]">
            <div class="w-20 h-20 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/30">
                <i class="fas fa-check text-4xl text-emerald-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­</h2>
            <div id="generated-code" class="bg-dark-900 p-4 rounded-xl border border-dashed border-slate-600 text-2xl font-mono text-emerald-400 my-6 select-all tracking-wider"></div>
            <button class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-600/30 transition-all" onclick="copyAndClose()">
                <i class="fas fa-copy mr-2"></i> Ù†Ø³Ø® ÙˆØ¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    </div>

    <div id="reply-modal" class="fixed inset-0 z-50 hidden-elm flex items-center justify-center bg-dark-900/80 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6 border border-emerald-500/30 shadow-2xl">
            <h3 class="text-xl font-bold text-emerald-400 mb-2">âœï¸ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø¯</h3>
            <p class="text-xs text-slate-500 mb-4">Ø§Ù„Ø±Ø¯ Ø³ÙŠØµÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨ ÙÙˆØ±Ø§Ù‹ Ø¹Ø¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</p>
            
            <div id="reply-to-info" class="bg-dark-900/50 p-3 rounded-lg text-sm text-slate-300 mb-4 border border-slate-700/50"></div>
            
            <textarea id="reply-text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." rows="5" class="w-full bg-dark-900 border border-slate-700 rounded-xl p-4 text-white focus:border-emerald-500 outline-none mb-4 resize-none"></textarea>
            
            <div class="flex gap-3">
                <button onclick="sendReplySubmit()" class="flex-[2] bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-600/20" id="submit-reply-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ ğŸš€</button>
                <button onclick="closeReplyModal()" class="flex-1 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/30 py-3 rounded-xl font-bold transition-all">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
        const ADMIN_MAP = {
            "0zb8DE5GgeYobn0wMzaXiDAPbiO2": { name: "giza", label: "Ø§Ù„Ø¬ÙŠØ²Ø© (Ø§Ù„Ù…Ø§Ù„Ùƒ)", role: "owner" },
            "YFYNXb6sBEPkwfikuYBBVe6ggZN2": { name: "sara", label: "Ø³Ø§Ø±Ø© (Ù…Ø´Ø±ÙØ©)", role: "manager" },
            "Zh16pJVYpwZet02RGbRPgdwFfoE2": { name: "mahmoud", label: "Ù…Ø­Ù…ÙˆØ¯ (Ù…Ø´Ø±Ù)", role: "staff" },
            "5cY88LU42yfwjlOng4ik6aADm863": { name: "ahmed", label: "Ø£Ø­Ù…Ø¯ (Ù…Ø´Ø±Ù)", role: "staff" }
        };

        const SERVER_URL = "https://admey.vercel.app/api/admin"; 
        let currentUser = null;
        let dbData = { codes: [], blocked_devices: {}, expenses: {} };
        let currentView = 'active'; 
        let currentScope = 'all';
        let charts = {}; 
        
        let allTickets = [];
        let currentTicketTab = 'pending';
        let currentReplyTicketId = null;

        // --- FIREBASE SETUP ---
        const firebaseConfigMain = { 
            apiKey: "AIzaSyD7PB4meIc-r2ijKzheD7P868CfKdsVej0", 
            databaseURL: "https://full-mark1-default-rtdb.firebaseio.com" 
        };
        const mainApp = firebase.initializeApp(firebaseConfigMain); 
        const mainAuth = mainApp.auth();

        const firebaseConfigTickets = {
            apiKey: "AIzaSyCm1yAULuM1D3ScjS9NUB2nCV_R-Y67QD4",
            authDomain: "reply-full.firebaseapp.com",
            databaseURL: "https://reply-full-default-rtdb.firebaseio.com",
            projectId: "reply-full",
            storageBucket: "reply-full.firebasestorage.app",
            messagingSenderId: "67591498026",
            appId: "1:67591498026:web:ebad8cfd2d79d3038cd653",
            measurementId: "G-J0WRD5YP1E"
        };
        const ticketApp = firebase.initializeApp(firebaseConfigTickets, "ticketsApp");
        const ticketDB = ticketApp.database();

        // --- LOGIN ---
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                const res = await mainAuth.signInWithEmailAndPassword(email, pass);
                if (!ADMIN_MAP[res.user.uid]) { alert("Unauthorized"); mainAuth.signOut(); }
            } catch (e) { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
        }

        mainAuth.onAuthStateChanged(user => {
            if (user && ADMIN_MAP[user.uid]) {
                currentUser = { ...ADMIN_MAP[user.uid], uid: user.uid };
                initDashboard();
            } else {
                document.getElementById('login-screen').classList.remove('hidden-elm');
                document.getElementById('admin-panel').classList.add('hidden-elm');
            }
        });

        function logout() { mainAuth.signOut(); }

        function initDashboard() {
            document.getElementById('login-screen').classList.add('hidden-elm');
            document.getElementById('admin-panel').classList.remove('hidden-elm');
            
            document.getElementById('welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.label}`;
            // document.getElementById('role-label-sidebar').innerText = currentUser.role.toUpperCase();

            if (currentUser.role === 'owner') {
                document.getElementById('stats-area').classList.remove('hidden-elm');
                document.getElementById('charts-area').classList.remove('hidden-elm');
            } else {
                currentScope = currentUser.name;
                document.getElementById('charts-area').classList.add('hidden-elm');
            }
            refreshData();
            
            if(currentUser.role === 'owner' || currentUser.role === 'manager') {
                loadTicketsSystem();
            }
        }

        async function refreshData() {
            try {
                const res = await fetch(`${SERVER_URL}/dashboard-data?admin_uuid=${currentUser.uid}&target_admin=${currentScope}`);
                dbData = await res.json();
                renderTable();
                updateStats(); 
                if (currentUser.role === 'owner') { initCharts(); }
            } catch (e) { console.error(e); }
        }

        // --- CHARTS ---
        function initCharts() {
            const ctx1 = document.getElementById('usersChart').getContext('2d');
            const ctx2 = document.getElementById('financeChart').getContext('2d');

            const activeCount = dbData.codes.filter(c => c.state === 'active' && !c.isTrial).length;
            const trialCount = dbData.codes.filter(c => c.isTrial).length;
            const expiredCount = dbData.codes.filter(c => c.state === 'expired').length;
            
            const revenue = dbData.codes.reduce((a, c) => a + (parseFloat(c.pricePaid) || 0), 0);
            const expenses = Object.values(dbData.expenses || {}).reduce((a, e) => a + (parseFloat(e.amount) || 0), 0);

            if (charts.users) charts.users.destroy();
            if (charts.finance) charts.finance.destroy();

            Chart.defaults.color = '#94a3b8';
            Chart.defaults.font.family = 'Cairo';

            charts.users = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Ù†Ø´Ø·', 'ØªØ¬Ø±ÙŠØ¨ÙŠ', 'Ù…Ù†ØªÙ‡ÙŠ', 'Ù…Ø­Ø¸ÙˆØ±'],
                    datasets: [{
                        data: [activeCount, trialCount, expiredCount, Object.keys(dbData.blocked_devices || {}).length],
                        backgroundColor: ['#3b82f6', '#f97316', '#64748b', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });

            charts.finance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Ø§Ù„Ø¯Ø®Ù„', 'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ', 'Ø§Ù„ØµØ§ÙÙŠ'],
                    datasets: [{
                        label: 'EGP',
                        data: [revenue, expenses, revenue - expenses],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#334155' } }, x: { grid: { display: false } } }
                }
            });
        }

        // --- NAVIGATION ---
        function switchMainTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => {
                t.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-lg');
                t.classList.add('text-slate-400');
                t.querySelector('i').classList.remove('text-white');
            });
            const activeBtn = event.currentTarget;
            activeBtn.classList.add('active', 'bg-blue-600', 'text-white', 'shadow-lg');
            activeBtn.classList.remove('text-slate-400');
            activeBtn.querySelector('i').classList.add('text-white');

            document.getElementById('dashboard-view').classList.add('hidden-elm');
            document.getElementById('tickets-view').classList.add('hidden-elm');
            document.getElementById('team-view').classList.add('hidden-elm');

            if(tabName === 'dashboard') document.getElementById('dashboard-view').classList.remove('hidden-elm');
            if(tabName === 'tickets') {
                document.getElementById('tickets-view').classList.remove('hidden-elm');
                renderTicketsGrid();
            }
            if(tabName === 'team') {
                document.getElementById('team-view').classList.remove('hidden-elm');
                renderTeamView();
            }
        }

        // --- TICKETS ---
        function loadTicketsSystem() {
            ticketDB.ref('support_tickets').on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) allTickets = [];
                else {
                    allTickets = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                    allTickets.sort((a, b) => b.timestamp - a.timestamp);
                }
                updateTicketStats();
                if(!document.getElementById('tickets-view').classList.contains('hidden-elm')) renderTicketsGrid();
            });
        }

        function updateTicketStats() {
            const pending = allTickets.filter(t => !t.isReplied).length;
            const replied = allTickets.filter(t => t.isReplied).length;
            document.getElementById('count-pending').innerText = pending;
            document.getElementById('count-replied').innerText = replied;
        }

        function switchTicketTab(tab, btn) {
            currentTicketTab = tab;
            document.querySelectorAll('.ticket-tab-btn').forEach(b => {
                b.classList.remove('active', 'text-blue-400', 'border-b-2', 'border-blue-400', 'font-bold');
                b.classList.add('text-slate-500');
            });
            btn.classList.add('active', 'text-blue-400', 'border-b-2', 'border-blue-400', 'font-bold');
            btn.classList.remove('text-slate-500');
            renderTicketsGrid();
        }

        function renderTicketsGrid() {
            const container = document.getElementById('tickets-container');
            container.innerHTML = '';
            const filtered = allTickets.filter(t => currentTicketTab === 'pending' ? !t.isReplied : t.isReplied);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-slate-500">
                    <i class="fas fa-check-circle text-4xl mb-4 opacity-50"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>
                </div>`;
                return;
            }

            filtered.forEach(ticket => {
                const date = new Date(ticket.timestamp).toLocaleString('ar-EG');
                const card = `
                    <div class="glass-panel p-5 rounded-xl border border-slate-700/50 hover:border-blue-500/30 transition-all group">
                        <div class="flex justify-between text-xs text-slate-500 mb-3 border-b border-slate-700 pb-2">
                            <span class="font-mono text-blue-400">#${ticket.id.substring(ticket.id.length - 4)}</span>
                            <span>${date}</span>
                        </div>
                        <h4 class="text-white font-bold mb-2 truncate">${ticket.subject}</h4>
                        <div class="bg-dark-900/50 p-3 rounded-lg text-sm text-slate-300 mb-3 border border-slate-700/50 h-24 overflow-y-auto custom-scroll">
                            ${ticket.message}
                        </div>
                        <div class="flex flex-wrap gap-2 text-xs mb-4">
                            <span class="bg-slate-700/50 text-slate-300 px-2 py-1 rounded flex items-center gap-1"><i class="fas fa-user"></i> ${ticket.studentName || '?'}</span>
                            <span class="bg-slate-700/50 text-slate-300 px-2 py-1 rounded flex items-center gap-1"><i class="fas fa-id-card"></i> ${ticket.studentCode}</span>
                        </div>
                        ${ticket.isReplied ? `<div class="bg-emerald-500/10 text-emerald-400 p-2 rounded text-xs mb-3 border border-emerald-500/20"><b>Ø§Ù„Ø±Ø¯:</b> ${ticket.adminReply}</div>` : ''}
                        
                        <div class="flex gap-2 pt-2 border-t border-slate-700/50">
                            <button onclick="deleteTicket('${ticket.id}')" class="px-3 py-2 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-lg transition-all"><i class="fas fa-trash"></i></button>
                            ${ticket.isReplied ? 
                                `<button onclick="deleteReplyOnly('${ticket.id}')" class="flex-1 bg-orange-500/10 hover:bg-orange-500 text-orange-500 hover:text-white rounded-lg transition-all text-xs font-bold">Ø­Ø°Ù Ø§Ù„Ø±Ø¯</button>` : 
                                `<button onclick="openReplyModal('${ticket.id}', '${ticket.studentName}', '${ticket.studentCode}')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg transition-all text-sm font-bold shadow-lg shadow-emerald-600/20">Ø±Ø¯ Ø§Ù„Ø¢Ù† <i class="fas fa-reply"></i></button>`
                            }
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', card);
            });
        }

        // --- TEAM VIEW ---
        function renderTeamView() {
            const container = document.getElementById('team-view');
            container.innerHTML = '';
            Object.values(ADMIN_MAP).forEach(admin => {
                const adminCodes = dbData.codes.filter(c => c.addedByAdmin === admin.name);
                const activeCodes = adminCodes.filter(c => c.state === 'active').length;
                const totalRevenue = adminCodes.reduce((sum, c) => sum + (parseFloat(c.pricePaid) || 0), 0);

                container.innerHTML += `
                    <div class="glass-panel p-6 rounded-2xl text-center relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                        <div class="w-16 h-16 mx-auto bg-dark-900 rounded-full flex items-center justify-center border-2 border-blue-500 mb-3 shadow-lg shadow-blue-500/20 group-hover:scale-110 transition-transform">
                            <i class="fas fa-user-shield text-2xl text-blue-400"></i>
                        </div>
                        <h3 class="text-white font-bold text-lg">${admin.label}</h3>
                        <span class="inline-block px-3 py-1 bg-blue-500/10 text-blue-400 text-xs rounded-full border border-blue-500/20 mt-1 mb-4 uppercase tracking-wider">${admin.role}</span>
                        
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-dark-900/50 p-2 rounded-lg border border-slate-700">
                                <div class="text-slate-500 text-xs">Ø£ÙƒÙˆØ§Ø¯</div>
                                <div class="text-white font-bold">${adminCodes.length}</div>
                            </div>
                            <div class="bg-dark-900/50 p-2 rounded-lg border border-slate-700">
                                <div class="text-slate-500 text-xs">Ù†Ø´Ø·</div>
                                <div class="text-blue-400 font-bold">${activeCodes}</div>
                            </div>
                        </div>
                        <div class="mt-4 bg-emerald-500/10 text-emerald-400 py-2 rounded-lg font-bold text-sm border border-emerald-500/20">
                            ${totalRevenue} EGP
                        </div>
                    </div>
                `;
            });
        }

        // --- TABLE ---
        function updateStats() {
            const area = document.getElementById('stats-area');
            if(currentUser.role !== 'owner') return;
            const allCodesCount = dbData.codes.length;
            const activeCodes = dbData.codes.filter(c => c.state === 'active');
            
            // Generate stat cards
            const cards = [
                { title: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯', val: allCodesCount, color: 'text-blue-400', icon: 'fa-database' },
                { title: 'Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†', val: activeCodes.length, color: 'text-emerald-400', icon: 'fa-user-check' },
                // Add more if needed
            ];
            
            area.innerHTML = cards.map(c => `
                <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-xs">${c.title}</p>
                        <h3 class="text-2xl font-bold text-white">${c.val}</h3>
                    </div>
                    <div class="w-10 h-10 bg-dark-900 rounded-lg flex items-center justify-center ${c.color} border border-slate-700">
                        <i class="fas ${c.icon}"></i>
                    </div>
                </div>
            `).join('');
        }

        function renderTable() {
            const head = document.getElementById('table-head');
            const body = document.getElementById('table-body');
            body.innerHTML = '';
            
            if (currentView === 'banned') { renderBannedView(); return; }
            
            head.innerHTML = `<tr><th class="p-4 text-right">Ø§Ù„Ø·Ø§Ù„Ø¨</th><th class="p-4 text-right">Ø§Ù„ÙƒÙˆØ¯</th><th class="p-4 text-right">Ø¨ÙˆØ§Ø³Ø·Ø©</th><th class="p-4 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-4 text-right">Ø§Ù„Ø³Ø¹Ø±</th><th class="p-4 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>`;

            let list = currentView === 'trial' ? dbData.codes.filter(c => c.isTrial) : dbData.codes.filter(c => c.state === currentView);
            if (currentUser.role !== 'owner') list = list.filter(c => c.addedByAdmin === currentUser.name);

            list.forEach(item => {
                const badge = item.isTrial ? '<span class="bg-orange-500/10 text-orange-400 text-[10px] px-2 py-0.5 rounded border border-orange-500/30 ml-2">TRIAL</span>' : '';
                const row = `
                    <tr class="hover:bg-slate-800/30 transition-colors group">
                        <td class="p-4">
                            <div class="font-bold text-white">${item.name} ${badge}</div>
                            <div class="text-xs text-slate-500">${item.section}</div>
                        </td>
                        <td class="p-4 font-mono text-blue-400 tracking-wider">${item.code}</td>
                        <td class="p-4 text-slate-400">${item.addedByAdmin}</td>
                        <td class="p-4">${formatDuration(item)}</td>
                        <td class="p-4 font-bold text-emerald-400">${item.pricePaid}</td>
                        <td class="p-4">
                            <div class="flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="copyText('${item.code}')" class="w-8 h-8 rounded-lg bg-blue-600 text-white flex items-center justify-center hover:bg-blue-500" title="Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯"><i class="fas fa-copy text-xs"></i></button>
                                <button onclick="copyText('${item.deviceId}')" class="w-8 h-8 rounded-lg bg-cyan-600 text-white flex items-center justify-center hover:bg-cyan-500" title="Ù†Ø³Ø® ID Ø§Ù„Ø¬Ù‡Ø§Ø²"><i class="fas fa-fingerprint text-xs"></i></button>
                                <button onclick="openEditModal('${item.code}')" class="w-8 h-8 rounded-lg bg-emerald-600 text-white flex items-center justify-center hover:bg-emerald-500" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit text-xs"></i></button>
                                <button onclick="quickAction('${item.code}', 'eject_device')" class="w-8 h-8 rounded-lg bg-orange-600 text-white flex items-center justify-center hover:bg-orange-500" title="Ø·Ø±Ø¯"><i class="fas fa-sign-out-alt text-xs"></i></button>
                                <button onclick="quickAction('${item.code}', 'toggle_block')" class="w-8 h-8 rounded-lg bg-slate-600 text-white flex items-center justify-center hover:bg-slate-500" title="ØªØ¹Ø·ÙŠÙ„"><i class="fas fa-power-off text-xs"></i></button>
                                <button onclick="quickAction('${item.code}', 'delete')" class="w-8 h-8 rounded-lg bg-red-600 text-white flex items-center justify-center hover:bg-red-500" title="Ø­Ø°Ù"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        </td>
                    </tr>`;
                body.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderBannedView() {
            const head = document.getElementById('table-head');
            const body = document.getElementById('table-body');
            head.innerHTML = `<tr><th class="p-4 text-right">Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th class="p-4 text-right">Ø§Ù„Ø­Ø§Ø¸Ø±</th><th class="p-4 text-right">Ø§Ù„Ø³Ø¨Ø¨</th><th class="p-4 text-center">ÙÙƒ Ø§Ù„Ø­Ø¸Ø±</th></tr>`;
            
            Object.values(dbData.blocked_devices || {}).forEach(d => {
                body.innerHTML += `<tr>
                    <td class="p-4 font-mono text-red-400">${d.deviceId}</td>
                    <td class="p-4 text-slate-300">${d.blockedBy}</td>
                    <td class="p-4 text-slate-400 text-sm">${d.reason}</td>
                    <td class="p-4 text-center"><button class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm" onclick="unbanDevice('${d.deviceId}')">Unban</button></td>
                </tr>`;
            });
        }

        // --- HELPERS & ACTIONS ---
        function openCreateModal(mode) {
            document.getElementById('modal-title').innerText = mode === 'trial' ? "Ø¥ØµØ¯Ø§Ø± ÙƒÙˆØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠ" : "Ø¥ØµØ¯Ø§Ø± ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯";
            document.getElementById('edit-mode-id').value = "";
            document.getElementById('duration-section').classList.remove('hidden-elm');
            document.getElementById('m-name').value = "";
            document.getElementById('m-price').value = mode === 'trial' ? "0" : "0";
            document.getElementById('m-duration').value = mode === 'trial' ? "trial" : "month";
            toggleCustomDays(document.getElementById('m-duration').value);
            document.getElementById('actionModal').classList.remove('hidden-elm');
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (EDIT)
        function openEditModal(code) {
            const item = dbData.codes.find(c => c.code === code);
            if (!item) return;
            document.getElementById('modal-title').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨";
            document.getElementById('edit-mode-id').value = code;
            document.getElementById('m-name').value = item.name;
            document.getElementById('m-section').value = item.section;
            document.getElementById('m-price').value = item.pricePaid;
            document.getElementById('duration-section').classList.add('hidden-elm'); // Hide duration on edit
            document.getElementById('actionModal').classList.remove('hidden-elm');
        }

        async function submitSave() {
            const editId = document.getElementById('edit-mode-id').value;
            const btn = document.querySelector('#actionModal .btn-success');
            
            const payload = {
                name: document.getElementById('m-name').value, 
                section: document.getElementById('m-section').value,
                price: parseFloat(document.getElementById('m-price').value),
                admin_uuid: currentUser.uid
            };
            payload.student_name = payload.name;
            
            btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

            try {
                if (editId) {
                    // Update Mode
                    payload.code = editId; 
                    payload.action = 'update_student';
                    
                    const res = await fetch(`${SERVER_URL}/take-action`, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (res.ok) { 
                        closeModal(); 
                        refreshData(); 
                        alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); 
                    } else {
                        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±");
                    }
                } else {
                    // Create Mode
                    payload.duration_type = document.getElementById('m-duration').value;
                    payload.custom_days = parseInt(document.getElementById('m-days').value) || 0;
                    
                    const res = await fetch(`${SERVER_URL}/create-code`, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify(payload) 
                    });
                    
                    const data = await res.json();
                    closeModal();
                    document.getElementById('generated-code').innerText = data.code;
                    document.getElementById('successModal').classList.remove('hidden-elm');
                    refreshData();
                }
            } catch (e) { console.error(e); alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
            finally { btn.disabled = false; btn.innerText = "Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"; }
        }

        async function quickAction(code, action) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ")) return;
            await fetch(`${SERVER_URL}/take-action`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code, action, admin_uuid: currentUser.uid }) });
            refreshData();
        }

        async function unbanDevice(deviceId) {
            await fetch(`${SERVER_URL}/take-action`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code: deviceId, action: 'unban_device', admin_uuid: currentUser.uid }) });
            refreshData();
        }

        // Helpers
        function formatDuration(item) {
            if (item.state !== 'active') return `<span class="text-slate-500">Ù…Ù†ØªÙ‡ÙŠ</span>`;
            const rem = item.expiry - Date.now();
            if (rem <= 0) return `<span class="text-red-400 font-bold">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª</span>`;
            if (item.isTrial) {
                const min = Math.floor(rem/60000);
                return min < 60 ? `<span class="text-orange-400 font-bold">${min} Ø¯Ù‚ÙŠÙ‚Ø©</span>` : `<span class="text-orange-400 font-bold">${Math.floor(min/60)} Ø³Ø§Ø¹Ø©</span>`;
            }
            return `<span class="text-emerald-400 font-bold">${Math.ceil(rem / 86400000)} ÙŠÙˆÙ…</span>`;
        }

        function copyText(t) { if(t) navigator.clipboard.writeText(t); }
        function closeModal() { 
            document.getElementById('actionModal').classList.add('hidden-elm'); 
            document.getElementById('successModal').classList.add('hidden-elm');
        }
        function copyAndClose() { copyText(document.getElementById('generated-code').innerText); closeModal(); }
        function toggleCustomDays(v) { document.getElementById('m-days').style.display = v === 'custom' ? 'block' : 'none'; }
        
        function setView(v, b) { 
            currentView = v; 
            document.querySelectorAll('.sub-nav .nav-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-lg');
                btn.classList.add('text-slate-400', 'hover:bg-slate-700');
            }); 
            b.classList.add('active', 'bg-blue-600', 'text-white', 'shadow-lg');
            b.classList.remove('text-slate-400', 'hover:bg-slate-700');
            renderTable(); 
        }

        function filterTable() {
            const val = document.getElementById("searchInput").value.toLowerCase();
            document.querySelectorAll("#table-body tr").forEach(row => { row.style.display = row.innerText.toLowerCase().includes(val) ? "" : "none"; });
        }

        // TICKET MODAL
        function openReplyModal(id, name, code) {
            currentReplyTicketId = id;
            document.getElementById('reply-text').value = '';
            document.getElementById('reply-to-info').innerText = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰: ${name} (${code})`;
            document.getElementById('reply-modal').classList.remove('hidden-elm');
        }
        function closeReplyModal() {
            document.getElementById('reply-modal').classList.add('hidden-elm');
            currentReplyTicketId = null;
        }
        function sendReplySubmit() {
            const text = document.getElementById('reply-text').value;
            if (!text || !currentReplyTicketId) return alert("Ø§ÙƒØªØ¨ Ø±Ø¯ Ø§Ù„Ø£ÙˆÙ„!");
            const btn = document.getElementById('submit-reply-btn');
            btn.disabled = true; btn.innerText = "...";
            ticketDB.ref('support_tickets/' + currentReplyTicketId).update({
                isReplied: true, adminReply: text, replyDate: firebase.database.ServerValue.TIMESTAMP
            }).then(() => { closeReplyModal(); alert("ØªÙ… Ø§Ù„Ø±Ø¯ âœ…"); })
            .finally(() => { btn.disabled = false; btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ ğŸš€"; });
        }
        function deleteTicket(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) ticketDB.ref('support_tickets/' + id).remove(); }
        function deleteReplyOnly(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ø±Ø¯ ÙÙ‚Ø·ØŸ")) ticketDB.ref('support_tickets/' + id).update({ isReplied: false, adminReply: null }); }

    </script>
</body>
</html>
