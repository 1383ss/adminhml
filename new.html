<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIZA ELITE | Engineer Zone</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #0b0c10; --card-bg: #1f2833; --accent: #ff6b00; --text: #c5c6c7;
            --success: #2ecc71; --danger: #e74c3c; --warning: #f1c40f;
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; }
        body { background-color: var(--bg); color: var(--text); margin: 0; min-height: 100vh; background-image: linear-gradient(rgba(255, 107, 0, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 107, 0, 0.05) 1px, transparent 1px); background-size: 40px 40px; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-box { background: var(--card-bg); padding: 50px 40px; border-top: 5px solid var(--accent); width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        input, select, textarea { width: 100%; padding: 15px; margin: 10px 0; background: #121418; border: 1px solid #333; color: var(--accent); font-family: 'Fira Code', monospace; }
        .btn { padding: 12px 25px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; display: inline-flex; align-items: center; justify-content: center; gap: 10px; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover { background: #ff8533; }
        .btn-danger { background: rgba(231, 76, 60, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-success { background: rgba(46, 204, 113, 0.2); color: var(--success); border: 1px solid var(--success); }

        /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #admin-panel { display: none; padding: 20px; max-width: 1800px; margin: auto; }
        .header { background: var(--card-bg); padding: 20px; display: flex; justify-content: space-between; border-right: 4px solid var(--accent); margin-bottom: 20px; }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .data-container { background: var(--card-bg); overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { padding: 15px; background: #161b22; color: var(--accent); text-align: right; }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover td { background: rgba(255, 107, 0, 0.05); }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 30px; width: 95%; max-width: 500px; border: 2px solid var(--accent); }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… */
        .act-btn { width: 32px; height: 32px; border: none; cursor: pointer; margin-left: 5px; color: #fff; display: inline-flex; justify-content: center; align-items: center; }
        .btn-edt { background: var(--accent); color: #000; }
        .btn-del { background: var(--danger); }
        .btn-copy { background: #3498db; }
        
        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .nav-tab { background: transparent; color: #777; padding: 10px 20px; border: none; cursor: pointer; font-size: 1.1rem; border-bottom: 3px solid transparent; }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:#fff; margin-bottom:5px">ENGINEER ZONE</h2>
            <p style="color:#666; font-size:0.9rem">SECURE ACCESS V2</p>
            <input type="email" id="email" placeholder="ACCESS ID">
            <input type="password" id="password" placeholder="SECURITY PIN">
            <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="handleLogin()">LOGIN</button>
        </div>
    </div>

    <div id="admin-panel">
        <div class="header">
            <div>
                <h3 id="welcome-msg" style="margin:0; color:#fff">SYSTEM ONLINE</h3>
                <div id="role-label" style="color:var(--accent); font-size:0.9rem"></div>
            </div>
            <div>
                <button class="btn btn-success" onclick="openCreateModal()"><i class="fas fa-plus"></i> ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</button>
                <button class="btn btn-danger" onclick="logout()"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <div style="margin-bottom:20px; border-bottom:1px solid #333">
            <button class="nav-tab active" onclick="switchView('dashboard')">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
            <button class="nav-tab" onclick="switchView('tickets')">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
        </div>

        <div id="dashboard-view">
            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." style="width:100%; margin-bottom:15px">
            <div class="data-container">
                <table id="main-table">
                    <thead>
                        <tr><th>Code</th><th>Name</th><th>Section</th><th>Price</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
        
        <div id="tickets-view" style="display:none; text-align:center; padding:50px; color:#666">
            <h3>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©...</h3>
        </div>
    </div>

    <div id="actionModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="color:var(--accent); margin-top:0">DATA ENTRY</h3>
            
            <input type="hidden" id="target-code-hidden">
            
            <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <input type="text" id="m-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ">
            
            <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <select id="m-section">
                <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>
                <option value="Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option>
                <option value="Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option>
                <option value="Ø£Ø¯Ø¨ÙŠ">Ø£Ø¯Ø¨ÙŠ</option>
            </select>
            
            <label>Ø§Ù„Ø³Ø¹Ø± (EGP)</label>
            <input type="number" id="m-price" value="0">

            <div id="create-options">
                <label>Ø§Ù„Ù†ÙˆØ¹</label>
                <select id="m-duration">
                    <option value="month">Ø´Ù‡Ø± ÙƒØ§Ù…Ù„</option>
                    <option value="trial">ØªØ¬Ø±Ø¨Ø© Ù…Ø¬Ø§Ù†ÙŠØ©</option>
                </select>
            </div>

            <div style="margin-top:20px; display:flex; gap:10px">
                <button class="btn btn-primary" style="flex:1" onclick="executeAction()">Ø­ÙØ¸ / ØªÙ†ÙÙŠØ° ğŸš€</button>
                <button class="btn btn-danger" onclick="closeModals()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content" style="text-align:center; border-color:var(--success)">
            <i class="fas fa-check-circle fa-4x" style="color:var(--success)"></i>
            <h2 style="color:#fff">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!</h2>
            <div id="new-code-display" style="background:#000; color:var(--success); font-size:1.5rem; padding:10px; margin:15px 0; border:1px dashed var(--success)"></div>
            <button class="btn btn-success" onclick="location.reload()">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</button>
        </div>
    </div>

    <script>
        // --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        const ADMIN_MAP = {
            "0zb8DE5GgeYobn0wMzaXiDAPbiO2": { name: "giza", label: "Eng. Giza", role: "owner" },
            "YFYNXb6sBEPkwfikuYBBVe6ggZN2": { name: "sara", label: "Eng. Sara", role: "manager" },
            "Zh16pJVYpwZet02RGbRPgdwFfoE2": { name: "mahmoud", label: "Eng. Mahmoud", role: "staff" },
            "5cY88LU42yfwjlOng4ik6aADm863": { name: "ahmed", label: "Eng. Ahmed", role: "staff" }
        };
        const API_URL = "https://admey.vercel.app/api/admin";

        // Firebase Init
        const firebaseConfig = { apiKey: "AIzaSyD7PB4meIc-r2ijKzheD7P868CfKdsVej0", databaseURL: "https://full-mark1-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        let currentUser = null;
        let tableData = [];

        // --- 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                const res = await auth.signInWithEmailAndPassword(email, pass);
                if (!ADMIN_MAP[res.user.uid]) throw new Error("Unauthorized");
            } catch(e) { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
        }

        auth.onAuthStateChanged(user => {
            if(user && ADMIN_MAP[user.uid]) {
                currentUser = { uid: user.uid, ...ADMIN_MAP[user.uid] };
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('welcome-msg').innerText = `WELCOME, ${currentUser.name.toUpperCase()}`;
                fetchData();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });

        function logout() { auth.signOut(); location.reload(); }

        // --- 3. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        async function fetchData() {
            try {
                const res = await fetch(`${API_URL}/dashboard-data?admin_uuid=${currentUser.uid}&target_admin=all`);
                const data = await res.json();
                tableData = data.codes || [];
                renderTable();
            } catch(e) { console.error(e); }
        }

        // --- 4. Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ---
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            tableData.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td style="font-family:'Fira Code'; color:var(--accent)">${item.code}</td>
                        <td>${item.name}</td>
                        <td>${item.section || '-'}</td>
                        <td style="color:var(--success)">${item.pricePaid || 0} EGP</td>
                        <td>
                            <button class="act-btn btn-copy" onclick="navigator.clipboard.writeText('${item.code}')"><i class="fas fa-copy"></i></button>
                            <button class="act-btn btn-edt" onclick="openEdit('${item.code}', '${item.name}', '${item.section}', '${item.pricePaid}')"><i class="fas fa-edit"></i></button>
                            <button class="act-btn btn-del" onclick="deleteCode('${item.code}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- 5. ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø¥Ù†Ø´Ø§Ø¡ / ØªØ¹Ø¯ÙŠÙ„) ---
        function openCreateModal() {
            document.getElementById('modal-title').innerText = "Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯";
            document.getElementById('target-code-hidden').value = ""; // ÙØ§Ø¶ÙŠ Ø¹Ø´Ø§Ù† Ø¯Ù‡ Ø¥Ù†Ø´Ø§Ø¡
            document.getElementById('m-name').value = "";
            document.getElementById('m-price').value = "0";
            document.getElementById('create-options').style.display = 'block';
            document.getElementById('actionModal').style.display = 'flex';
        }

        function openEdit(code, name, section, price) {
            document.getElementById('modal-title').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨";
            // Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±: Ø¨Ù†Ø­Ø· Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ Ø¹Ø´Ø§Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙˆÙ‚Øª Ø§Ù„Ø­ÙØ¸
            document.getElementById('target-code-hidden').value = code;
            
            document.getElementById('m-name').value = name;
            document.getElementById('m-section').value = section !== 'undefined' ? section : 'Ø¹Ø§Ù…';
            document.getElementById('m-price').value = price !== 'undefined' ? price : 0;
            
            document.getElementById('create-options').style.display = 'none'; // Ù†Ø®ÙÙŠ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¯Ø© ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            document.getElementById('actionModal').style.display = 'flex';
        }

        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }

        // --- 6. ØªÙ†ÙÙŠØ° Ø§Ù„Ø£ÙƒØ´Ù† (Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯) ---
        async function executeAction() {
            const btn = document.querySelector('#actionModal .btn-primary');
            const targetCode = document.getElementById('target-code-hidden').value;
            const name = document.getElementById('m-name').value;
            const section = document.getElementById('m-section').value;
            const price = document.getElementById('m-price').value;
            
            if(!name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨!");

            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...";
            btn.disabled = true;

            const payload = {
                admin_uuid: currentUser.uid,
                name: name,
                student_name: name, // Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚
                section: section,
                price: parseFloat(price),
                pricePaid: parseFloat(price) // Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚
            };

            try {
                if (targetCode) {
                    // === Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (UPDATE) ===
                    // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø¨Ø§ÙŠÙ„ÙˆØ¯ Ø§Ù„Ù„ÙŠ Ù†Ø¬Ø­ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­
                    payload.code = targetCode;
                    payload.action = 'update_student'; // Ø§Ù„Ø£ÙƒØ´Ù† Ø§Ù„ØµØ­ÙŠØ­

                    const res = await fetch(`${API_URL}/take-action`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if(res.ok) {
                        alert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                        location.reload(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØºÙŠÙŠØ±
                    } else {
                        const err = await res.json();
                        alert("Ø®Ø·Ø£: " + JSON.stringify(err));
                    }

                } else {
                    // === Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (CREATE) ===
                    payload.duration_type = document.getElementById('m-duration').value;
                    const res = await fetch(`${API_URL}/create-code`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    
                    if(data.code) {
                        closeModals();
                        document.getElementById('new-code-display').innerText = data.code;
                        document.getElementById('successModal').style.display = 'flex';
                    } else {
                        alert("ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡");
                    }
                }
            } catch(e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + e);
            } finally {
                btn.innerText = "Ø­ÙØ¸ / ØªÙ†ÙÙŠØ° ğŸš€";
                btn.disabled = false;
            }
        }

        // --- 7. Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ ---
        async function deleteCode(code) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ØŸ")) return;
            await fetch(`${API_URL}/take-action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    admin_uuid: currentUser.uid,
                    action: 'delete',
                    code: code
                })
            });
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù");
            location.reload();
        }

        // --- Ø¨Ø­Ø« Ø¨Ø³ÙŠØ· ---
        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('tbody tr').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
            });
        }
        
        function switchView(v) {
            document.getElementById('dashboard-view').style.display = v==='dashboard'?'block':'none';
            document.getElementById('tickets-view').style.display = v==='tickets'?'block':'none';
        }
    </script>
</body>
</html>
