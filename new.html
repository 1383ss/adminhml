<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIZA ELITE | Turbo Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #ff6b00; --text: #ddd; }
        body { background: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; margin: 0; padding: 20px; }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø³Ø±Ø¹Ø©: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¸Ù„Ø§Ù„ Ø§Ù„Ø«Ù‚ÙŠÙ„Ø© */
        .container { max-width: 1400px; margin: auto; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px; border-right: 4px solid var(--accent); margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; cursor: pointer; font-weight: bold; display: inline-flex; gap: 5px; align-items: center; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-danger { background: #d32f2f; color: #fff; }
        
        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ */
        .table-wrapper { overflow-x: auto; background: var(--card); border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #2c2c2c; color: var(--accent); padding: 10px; text-align: right; }
        td { padding: 8px 10px; border-bottom: 1px solid #333; }
        tr:hover { background: #252525; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª */
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .page-btn { background: #333; color: #fff; padding: 8px 15px; border: none; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #222; padding: 30px; width: 400px; border: 2px solid var(--accent); }
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px; background: #000; border: 1px solid #444; color: #fff; box-sizing: border-box; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loader { text-align: center; padding: 50px; color: var(--accent); font-size: 1.5rem; display: none; }
    </style>
</head>
<body>

    <div id="login-view" style="height: 100vh; display: flex; justify-content: center; align-items: center;">
        <div style="background: var(--card); padding: 40px; text-align: center; width: 300px; border-top: 4px solid var(--accent);">
            <h2 style="margin: 0 0 20px;">ENGINEER ZONE</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn btn-primary" onclick="login()" style="width: 100%;">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="app-view" style="display: none;" class="container">
        <div class="header">
            <h3>SYSTEM ONLINE <span id="user-role" style="font-size: 0.8rem; color: #888;"></span></h3>
            <div>
                <button class="btn btn-primary" onclick="openModal('create')"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
                <button class="btn btn-danger" onclick="logout()"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." onkeyup="handleSearch()" style="margin: 0;">
            <div style="background: var(--card); padding: 10px; min-width: 150px; text-align: center;">Ø§Ù„Ø¹Ø¯Ø¯: <span id="total-count">0</span></div>
        </div>

        <div id="loader"><i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ÙƒÙˆØ¯</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

        <div class="pagination">
            <button class="page-btn" onclick="changePage(-1)">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <span id="page-info" style="padding: 8px;">ØµÙØ­Ø© 1</span>
            <button class="page-btn" onclick="changePage(1)">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
    </div>

    <div id="action-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="color: var(--accent); margin-top: 0;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            
            <input type="hidden" id="target-code"> <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <input type="text" id="m-name">
            
            <label>Ø§Ù„Ø³Ø¹Ø± (Ù…Ø¯ÙÙˆØ¹)</label>
            <input type="number" id="m-price">
            
            <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <select id="m-section">
                <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>
                <option value="Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option>
                <option value="Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option>
                <option value="Ø£Ø¯Ø¨ÙŠ">Ø£Ø¯Ø¨ÙŠ</option>
                <option value="Ø£Ø²Ù‡Ø±">Ø£Ø²Ù‡Ø±</option>
            </select>

            <div id="create-extra" style="display:none;">
                <label>Ø§Ù„Ù…Ø¯Ø©</label>
                <select id="m-duration">
                    <option value="month">Ø´Ù‡Ø±</option>
                    <option value="trial">ØªØ¬Ø±Ø¨Ø©</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="submitAction()" style="width: 100%;">Ø­ÙØ¸ ÙˆØªÙ†ÙÙŠØ° ğŸš€</button>
            <button class="btn btn-danger" onclick="closeModal()" style="width: 100%; margin-top: 10px; background: transparent; border: 1px solid #555;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ---
        const ADMINS = ["0zb8DE5GgeYobn0wMzaXiDAPbiO2", "YFYNXb6sBEPkwfikuYBBVe6ggZN2", "Zh16pJVYpwZet02RGbRPgdwFfoE2", "5cY88LU42yfwjlOng4ik6aADm863"];
        const API = "https://admey.vercel.app/api/admin";
        
        firebase.initializeApp({ apiKey: "AIzaSyD7PB4meIc-r2ijKzheD7P868CfKdsVej0", authDomain: "full-mark1.firebaseapp.com" });
        const auth = firebase.auth();
        let currentUserIdx = "";

        // --- 2. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ø³Ø±Ø¹Ø©) ---
        let allStudents = [];      // ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù‡Ù†Ø§
        let filteredStudents = []; // Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù‡Ù†Ø§
        let currentPage = 1;
        const rowsPerPage = 50;    // Ø¹Ø±Ø¶ 50 ÙÙ‚Ø· ÙÙŠ ÙƒÙ„ ØµÙØ­Ø© Ù„Ù„Ø³Ø±Ø¹Ø©

        // --- 3. Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        async function login() {
            try {
                const user = await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value);
                if (!ADMINS.includes(user.user.uid)) throw new Error("Not Admin");
            } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message); }
        }

        auth.onAuthStateChanged(u => {
            if(u && ADMINS.includes(u.uid)) {
                currentUserIdx = u.uid;
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('app-view').style.display = 'block';
                loadData();
            } else {
                document.getElementById('login-view').style.display = 'flex';
                document.getElementById('app-view').style.display = 'none';
            }
        });
        function logout() { auth.signOut(); }

        // --- 4. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©) ---
        async function loadData() {
            document.getElementById('loader').style.display = 'block';
            document.querySelector('.table-wrapper').style.display = 'none';
            try {
                // Ø¨Ù†Ø·Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
                const res = await fetch(`${API}/dashboard-data?admin_uuid=${currentUserIdx}&target_admin=all`);
                const data = await res.json();
                allStudents = data.codes || [];
                filteredStudents = [...allStudents]; // ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŒ Ø§Ù„Ù…ÙÙ„ØªØ± Ù‡Ùˆ Ø§Ù„ÙƒÙ„
                
                document.getElementById('total-count').innerText = allStudents.length;
                renderPage();
            } catch(e) { alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + e); }
            finally {
                document.getElementById('loader').style.display = 'none';
                document.querySelector('.table-wrapper').style.display = 'block';
            }
        }

        // --- 5. Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ (Client Side) ---
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const term = document.getElementById('search-box').value.toLowerCase();
                if (!term) {
                    filteredStudents = [...allStudents];
                } else {
                    filteredStudents = allStudents.filter(s => 
                        s.code.toLowerCase().includes(term) || 
                        s.name.toLowerCase().includes(term)
                    );
                }
                currentPage = 1; // Ø§Ø±Ø¬Ø¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                renderPage();
            }, 300); // Ø§Ø³ØªÙ†Ù‰ 300ms Ø¹Ø´Ø§Ù† Ù…ÙŠÙ‡Ù†Ø¬Ø´ Ù…Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
        }

        // --- 6. Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø£Ù‡Ù… Ø¬Ø²Ø¡ Ù„Ù„Ø³Ø±Ø¹Ø©) ---
        function renderPage() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredStudents.slice(start, end);

            document.getElementById('page-info').innerText = `ØµÙØ­Ø© ${currentPage} Ù…Ù† ${Math.ceil(filteredStudents.length / rowsPerPage)}`;

            pageData.forEach(s => {
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªØ§Ø­
                const price = s.pricePaid || s.price || 0;
                const row = `
                    <tr>
                        <td style="font-family:'Fira Code'; color:var(--accent)">${s.code}</td>
                        <td>${s.name}</td>
                        <td style="color:#2ecc71">${price}</td>
                        <td>${s.section || '-'}</td>
                        <td>
                            <button class="btn" style="background:#333; padding:5px 10px" onclick="openEdit('${s.code}', '${s.name}', '${price}', '${s.section}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function changePage(dir) {
            const maxPage = Math.ceil(filteredStudents.length / rowsPerPage);
            if (currentPage + dir > 0 && currentPage + dir <= maxPage) {
                currentPage += dir;
                renderPage();
            }
        }

        // --- 7. Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„ØªØµÙ„ÙŠØ­) ---
        function openModal(mode) {
            document.getElementById('action-modal').style.display = 'flex';
            if (mode === 'create') {
                document.getElementById('modal-title').innerText = "Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯";
                document.getElementById('target-code').value = ""; // ÙØ§Ø¶ÙŠ
                document.getElementById('create-extra').style.display = 'block';
                document.getElementById('m-name').value = "";
                document.getElementById('m-price').value = "0";
            }
        }

        function openEdit(code, name, price, section) {
            document.getElementById('action-modal').style.display = 'flex';
            document.getElementById('modal-title').innerText = "ØªØ¹Ø¯ÙŠÙ„: " + name;
            document.getElementById('create-extra').style.display = 'none';
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('target-code').value = code;
            document.getElementById('m-name').value = name;
            document.getElementById('m-price').value = price;
            document.getElementById('m-section').value = (section && section !== 'undefined') ? section : 'Ø¹Ø§Ù…';
        }

        function closeModal() { document.getElementById('action-modal').style.display = 'none'; }

        async function submitAction() {
            const code = document.getElementById('target-code').value;
            const name = document.getElementById('m-name').value;
            const price = document.getElementById('m-price').value;
            const section = document.getElementById('m-section').value;
            
            if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…!");

            const btn = document.querySelector('#action-modal .btn-primary');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...";
            btn.disabled = true;

            const payload = {
                admin_uuid: currentUserIdx,
                name: name,
                student_name: name,
                section: section,
                price: parseFloat(price),
                pricePaid: parseFloat(price)
            };

            try {
                if (code) {
                    // === ØªØ¹Ø¯ÙŠÙ„ (Ù†ÙØ³ ÙƒÙˆØ¯ repair.html) ===
                    payload.code = code;
                    payload.action = 'update_student';
                    
                    const res = await fetch(`${API}/take-action`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                    });
                    
                    if (res.ok) {
                        alert("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„!");
                        closeModal();
                        loadData(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¸Ù‡Ø±
                    } else {
                        const err = await res.json();
                        alert("Ø®Ø·Ø£: " + JSON.stringify(err));
                    }
                } else {
                    // === Ø¥Ù†Ø´Ø§Ø¡ ===
                    payload.duration_type = document.getElementById('m-duration').value;
                    const res = await fetch(`${API}/create-code`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if(data.code) {
                        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯: " + data.code);
                        closeModal();
                        loadData();
                    } else { alert("ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"); }
                }
            } catch(e) { alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„: " + e); }
            finally {
                btn.innerText = "Ø­ÙØ¸ ÙˆØªÙ†ÙÙŠØ° ğŸš€";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
