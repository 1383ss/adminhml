<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIZA ELITE | Control Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root { --bg: #000000; --panel: #111; --border: #333; --accent: #ff6b00; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header { background: var(--panel); padding: 10px 20px; border-bottom: 2px solid var(--accent); display: flex; justify-content: space-between; align-items: center; height: 50px; }
        
        /* ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© */
        .main-layout { display: flex; flex: 1; height: calc(100vh - 50px); }
        
        /* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .list-section { flex: 2; border-left: 1px solid var(--border); overflow-y: auto; padding: 10px; }
        
        /* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø´Ù…Ø§Ù„: Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
        .editor-section { flex: 1; background: #0a0a0a; padding: 20px; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        
        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; color: #888; border-bottom: 1px solid var(--border); padding: 10px; font-size: 0.9rem; }
        td { padding: 10px; border-bottom: 1px solid #222; vertical-align: middle; }
        tr:hover { background: #1a1a1a; cursor: pointer; }
        .row-selected { background: rgba(255, 107, 0, 0.1) !important; border-right: 3px solid var(--accent); }
        
        /* Ø§Ù„ÙÙˆØ±Ù… */
        label { color: var(--accent); font-size: 0.8rem; margin-top: 15px; display: block; }
        input, select { width: 100%; background: #222; border: 1px solid #444; color: #fff; padding: 10px; font-family: 'Fira Code'; margin-top: 5px; box-sizing: border-box; }
        input:focus { border-color: var(--accent); outline: none; }
        
        .btn { padding: 12px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; text-transform: uppercase; }
        .btn-save { background: var(--accent); color: #000; }
        .btn-save:hover { background: #ff8533; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù„ÙˆØ¬ */
        #console-log { margin-top: auto; background: #000; border: 1px dashed #444; padding: 10px; height: 150px; overflow-y: auto; font-family: 'Fira Code'; font-size: 0.8rem; color: #0f0; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-view { position: fixed; inset: 0; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="login-view">
        <div style="text-align: center; width: 300px;">
            <i class="fas fa-shield-alt fa-3x" style="color: var(--accent); margin-bottom: 20px;"></i>
            <h2 style="color: #fff;">CONTROL ROOM</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn btn-save" onclick="login()">ENTER SYSTEM</button>
        </div>
    </div>

    <div class="header">
        <div><i class="fas fa-server"></i> GIZA ELITE SYSTEM</div>
        <button onclick="logout()" style="background:none; border:none; color:red; cursor:pointer;"><i class="fas fa-power-off"></i> Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="main-layout">
        
        <div class="editor-section">
            <h3 style="margin: 0 0 20px 0; border-bottom: 1px solid #333; padding-bottom: 10px;">
                <i class="fas fa-edit"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            </h3>
            
            <div id="editor-form" style="display:none; opacity: 1;">
                <input type="hidden" id="edit-code">
                
                <label>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)</label>
                <input type="text" id="view-code" disabled style="color:#555; cursor: not-allowed;">

                <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                <input type="text" id="edit-name">

                <label>Ø§Ù„Ø³Ø¹Ø± (EGP)</label>
                <input type="number" id="edit-price">

                <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
                <select id="edit-section">
                    <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>
                    <option value="Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option>
                    <option value="Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option>
                    <option value="Ø£Ø¯Ø¨ÙŠ">Ø£Ø¯Ø¨ÙŠ</option>
                </select>

                <button class="btn btn-save" onclick="saveChanges()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¢Ù† ğŸš€</button>
            </div>

            <div id="empty-msg" style="color:#666; text-align:center; margin-top:50px;">
                Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡
                <br><br>
                <button class="btn" style="background:#333; color:#fff" onclick="prepareCreate()">+ Ø£Ùˆ Ø£Ù†Ø´Ø¦ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</button>
                
                <div id="create-options" style="display:none; text-align:right; margin-top:20px;">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                    <input type="text" id="new-name-c">
                    <label>Ø§Ù„Ù…Ø¯Ø©</label>
                    <select id="new-dur-c"><option value="month">Ø´Ù‡Ø±</option><option value="trial">ØªØ¬Ø±Ø¨Ø©</option></select>
                    <button class="btn btn-save" onclick="createNew()">Ø¥Ù†Ø´Ø§Ø¡</button>
                </div>
            </div>

            <div id="console-log">System Ready...</div>
        </div>

        <div class="list-section">
            <input type="text" id="search" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." onkeyup="filterList()" style="margin-bottom: 10px;">
            <div id="loading" style="display:none; text-align:center; color:var(--accent);">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            <table id="students-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„ÙƒÙˆØ¯</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

    </div>

    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        const ADMINS = ["0zb8DE5GgeYobn0wMzaXiDAPbiO2", "YFYNXb6sBEPkwfikuYBBVe6ggZN2", "Zh16pJVYpwZet02RGbRPgdwFfoE2", "5cY88LU42yfwjlOng4ik6aADm863"];
        const API = "https://admey.vercel.app/api/admin";
        
        firebase.initializeApp({ apiKey: "AIzaSyD7PB4meIc-r2ijKzheD7P868CfKdsVej0", authDomain: "full-mark1.firebaseapp.com" });
        const auth = firebase.auth();
        let currentUserUid = "";
        let allData = [];

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù„ÙˆØ¬ (Console Log) ---
        function log(msg, type='info') {
            const el = document.getElementById('console-log');
            const color = type === 'error' ? 'red' : (type === 'success' ? '#0f0' : '#ccc');
            el.innerHTML += `<div style="color:${color}; margin-bottom:5px;">> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        // --- Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        async function login() {
            try {
                const u = await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value);
                if (!ADMINS.includes(u.user.uid)) throw "Not Allowed";
            } catch(e) { alert("Ø®Ø·Ø£ Ø¯Ø®ÙˆÙ„"); }
        }

        auth.onAuthStateChanged(u => {
            if(u && ADMINS.includes(u.uid)) {
                currentUserUid = u.uid;
                document.getElementById('login-view').style.display = 'none';
                fetchStudents();
            } else {
                document.getElementById('login-view').style.display = 'flex';
            }
        });
        function logout() { auth.signOut(); }

        // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        async function fetchStudents() {
            log("Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...");
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch(`${API}/dashboard-data?admin_uuid=${currentUserUid}&target_admin=all`);
                const json = await res.json();
                allData = json.codes || [];
                log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allData.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
                renderTable(allData);
            } catch(e) {
                log("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: " + e, 'error');
            }
            document.getElementById('loading').style.display = 'none';
        }

        // --- Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ---
        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            // Ù†Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 100 Ø¨Ø³ Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø©
            data.slice(0, 100).forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-family:'Fira Code'; color:var(--accent)">${s.code}</td>
                    <td>${s.name}</td>
                    <td>${s.pricePaid || s.price || 0}</td>
                    <td>${s.section || '-'}</td>
                `;
                tr.onclick = () => selectStudent(s, tr);
                tbody.appendChild(tr);
            });
        }

        // --- Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ---
        function selectStudent(student, rowElement) {
            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ Ø§Ù„Ù…Ø®ØªØ§Ø±
            document.querySelectorAll('tr').forEach(r => r.classList.remove('row-selected'));
            rowElement.classList.add('row-selected');

            // Ø¥Ø¸Ù‡Ø§Ø± ÙÙˆØ±Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§Øº
            document.getElementById('empty-msg').style.display = 'none';
            document.getElementById('editor-form').style.display = 'block';

            // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('edit-code').value = student.code;
            document.getElementById('view-code').value = student.code;
            document.getElementById('edit-name').value = student.name;
            document.getElementById('edit-price').value = student.pricePaid || student.price || 0;
            document.getElementById('edit-section').value = (student.section && student.section !== "undefined") ? student.section : "Ø¹Ø§Ù…";
            
            log(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}`);
        }

        // --- ØªÙ†ÙÙŠØ° Ø§Ù„Ø­ÙØ¸ (Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„ØªØµÙ„ÙŠØ­) ---
        async function saveChanges() {
            const code = document.getElementById('edit-code').value;
            const name = document.getElementById('edit-name').value;
            const price = document.getElementById('edit-price').value;
            const section = document.getElementById('edit-section').value;

            if(!code || !name) return log("Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©", 'error');

            log("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø³ÙŠØ±ÙØ±...", 'info');
            
            const payload = {
                admin_uuid: currentUserUid,
                action: 'update_student', // Ù†ÙØ³ Ø§Ù„Ø§ÙƒØ´Ù† Ø§Ù„Ù„ÙŠ Ø§Ø´ØªØºÙ„
                code: code,
                name: name,
                student_name: name,
                section: section,
                price: parseFloat(price),
                pricePaid: parseFloat(price)
            };

            try {
                const res = await fetch(`${API}/take-action`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const json = await res.json();

                if (res.ok) {
                    log("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø³ÙŠØ±ÙØ± Ø±Ø¯ Ø¨Ù€ OK", 'success');
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ø´Ø§Ù† Ù…ØªØ¶Ø·Ø±Ø´ ØªØ¹Ù…Ù„ Ø±ÙŠÙØ±ÙŠØ´
                    const idx = allData.findIndex(s => s.code === code);
                    if(idx !== -1) {
                        allData[idx].name = name;
                        allData[idx].pricePaid = price;
                        allData[idx].section = section;
                        renderTable(allData); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    }
                } else {
                    log("âŒ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨: " + JSON.stringify(json), 'error');
                }
            } catch(e) {
                log("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: " + e, 'error');
            }
        }

        // --- Ø§Ù„Ø¨Ø­Ø« ---
        function filterList() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = allData.filter(s => s.name.toLowerCase().includes(term) || s.code.toLowerCase().includes(term));
            renderTable(filtered);
        }

        // --- Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø±ÙŠØ¹ ---
        function prepareCreate() {
            document.getElementById('create-options').style.display = 'block';
        }
        async function createNew() {
            const name = document.getElementById('new-name-c').value;
            const dur = document.getElementById('new-dur-c').value;
            if(!name) return log("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…", 'error');
            
            log("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯...", 'info');
            const res = await fetch(`${API}/create-code`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    admin_uuid: currentUserUid,
                    name: name, student_name: name,
                    duration_type: dur,
                    price: 0
                })
            });
            const d = await res.json();
            if(d.code) {
                log(`âœ… ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${d.code}`, 'success');
                alert(`Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${d.code}`);
                fetchStudents(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            } else {
                log("ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡", 'error');
            }
        }
    </script>
</body>
</html>
