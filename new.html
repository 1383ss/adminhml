<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIZA ELITE | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #bb86fc; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ Ø§Ù„Ù…Ù…ÙŠØ² */
            --accent-hover: #9965f4;
            --border-color: #333;
            --success-color: #03dac6;
            --danger-color: #cf6679;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Cairo', sans-serif;
            min-height: 100vh;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ ÙƒØ±ÙˆØª Ø§Ù„Ø¨ÙˆØªØ³ØªØ±Ø§Ø¨ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .form-control, .form-select {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #fff;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: #333;
            color: #fff;
            border-color: var(--accent);
            box-shadow: 0 0 0 0.25rem rgba(187, 134, 252, 0.25);
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-primary { background-color: var(--accent); border-color: var(--accent); color: #000; font-weight: bold; }
        .btn-primary:hover { background-color: var(--accent-hover); border-color: var(--accent-hover); }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table { color: var(--text-main); border-color: var(--border-color); }
        .table thead th {
            background-color: #252525;
            color: var(--accent);
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
        }
        .table-hover tbody tr:hover { background-color: #2c2c2c; color: #fff; }
        
        /* Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø±Ù‚Ù…ÙŠØ© */
        .font-mono { font-family: 'Fira Code', monospace; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #1f1f1f 0%, #121212 100%);
        }
        .login-card { width: 100%; max-width: 400px; padding: 2rem; border-top: 4px solid var(--accent); }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal-content { background-color: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); }
        .modal-header, .modal-footer { border-color: var(--border-color); }
        .btn-close { filter: invert(1); }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .nav-pills .nav-link { color: var(--text-muted); border-radius: 8px; margin: 0 5px; }
        .nav-pills .nav-link.active { background-color: var(--accent); color: #000; font-weight: bold; }
        
        /* Ø§Ù„ÙÙ„ØªØ± Ø§Ù„ÙØ±Ø¹ÙŠ */
        .sub-nav-btn {
            background: transparent; border: 1px solid #444; color: #888;
            padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; transition: 0.3s;
        }
        .sub-nav-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(187, 134, 252, 0.1); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card login-card text-center">
            <div class="mb-4">
                <i class="fas fa-shield-alt fa-3x" style="color: var(--accent);"></i>
            </div>
            <h3 class="fw-bold mb-1">GIZA ELITE</h3>
            <p class="text-muted small mb-4">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¢Ù…Ù†</p>
            
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" placeholder="name@example.com">
                <label for="email" class="text-secondary">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Access ID)</label>
            </div>
            <div class="form-floating mb-4">
                <input type="password" class="form-control" id="password" placeholder="Password">
                <label for="password" class="text-secondary">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (PIN)</label>
            </div>
            <button class="btn btn-primary w-100 py-2" onclick="handleLogin()">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ <i class="fas fa-sign-in-alt ms-2"></i>
            </button>
        </div>
    </div>

    <div id="admin-panel" class="container-fluid py-4" style="display: none;">
        
        <div class="d-flex justify-content-between align-items-center mb-4 bg-dark p-3 rounded border border-secondary border-opacity-25">
            <div>
                <h4 class="fw-bold m-0 text-white font-mono">SYSTEM ONLINE</h4>
                <small id="role-label" class="text-info font-mono"></small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="openCreateModal('normal')"><i class="fas fa-plus"></i> ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</button>
                <button class="btn btn-outline-danger" onclick="logout()" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <ul class="nav nav-pills mb-4 justify-content-center">
            <li class="nav-item"><button class="nav-link active" onclick="switchMainTab('dashboard', this)"><i class="fas fa-sliders-h"></i> Ø§Ù„ØªØ­ÙƒÙ…</button></li>
            <li class="nav-item"><button class="nav-link" onclick="switchMainTab('tickets', this)"><i class="fas fa-envelope"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button></li>
            <li class="nav-item"><button class="nav-link" onclick="switchMainTab('team', this)"><i class="fas fa-users"></i> Ø§Ù„ÙØ±ÙŠÙ‚</button></li>
        </ul>

        <div id="dashboard-view">
            <div id="charts-area" class="row g-3 mb-4">
                <div class="col-md-6"><div class="card h-100"><div class="card-body"><canvas id="usersChart"></canvas></div></div></div>
                <div class="col-md-6"><div class="card h-100"><div class="card-body"><canvas id="financeChart"></canvas></div></div></div>
            </div>

            <div id="stats-area" class="row g-3 mb-4 text-center"></div>

            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 mb-3 justify-content-center sub-nav">
                        <button class="sub-nav-btn active" onclick="setView('active', this)">Ù…ÙØ¹Ù„ (Active)</button>
                        <button class="sub-nav-btn" onclick="setView('trial', this)">ØªØ¬Ø±ÙŠØ¨ÙŠ (Trial)</button>
                        <button class="sub-nav-btn" onclick="setView('disabled', this)">Ù…Ø¹Ø·Ù„ (Disabled)</button>
                        <button class="sub-nav-btn" onclick="setView('expired', this)">Ù…Ù†ØªÙ‡ÙŠ (Expired)</button>
                        <button class="sub-nav-btn" onclick="setView('banned', this)">Ù…Ø­Ø¸ÙˆØ± (Banned)</button>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text bg-dark border-secondary text-light"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" onkeyup="filterTable()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body p-0 table-responsive">
                    <table class="table table-hover align-middle mb-0 text-center" id="main-table">
                        <thead id="table-head"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tickets-view" style="display:none;">
            <div class="row g-3 mb-4">
                <div class="col-6">
                    <div class="card border-danger text-center p-3">
                        <h2 id="count-pending" class="text-danger fw-bold font-mono">0</h2>
                        <span class="text-muted">Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card border-success text-center p-3">
                        <h2 id="count-replied" class="text-success fw-bold font-mono">0</h2>
                        <span class="text-muted">ØªÙ… Ø§Ù„Ø±Ø¯</span>
                    </div>
                </div>
            </div>
            
            <div class="mb-3 d-flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="switchTicketTab('pending')">ÙˆØ§Ø±Ø¯ Ø¬Ø¯ÙŠØ¯</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="switchTicketTab('replied')">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
            </div>

            <div id="tickets-container" class="row g-3"></div>
        </div>

        <div id="team-view" style="display:none;">
            <div class="row g-4" id="team-grid"></div>
        </div>

    </div>

    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title font-mono" id="modal-title">DATA ENTRY</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-mode-id">
                    
                    <div class="mb-3">
                        <label class="form-label text-muted">Ø§Ù„Ø§Ø³Ù…</label>
                        <input type="text" id="m-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted">Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
                        <select id="m-section" class="form-select">
                            <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>
                            <option value="Ø£Ø¯Ø¨ÙŠ">Ø£Ø¯Ø¨ÙŠ</option>
                            <option value="Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option>
                            <option value="Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option>
                            <option value="Ø£Ø²Ù‡Ø±">Ø£Ø²Ù‡Ø±</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted">Ø§Ù„Ù…Ø¨Ù„Øº (EGP)</label>
                        <input type="number" id="m-price" class="form-control" value="0">
                    </div>

                    <div id="duration-section" class="mb-3">
                        <label class="form-label text-muted">Ø§Ù„Ù…Ø¯Ø©</label>
                        <select id="m-duration" class="form-select mb-2" onchange="toggleCustomDays(this.value)">
                            <option value="month">Ø´Ù‡Ø± (30 ÙŠÙˆÙ…)</option>
                            <option value="trial">ØªØ¬Ø±Ø¨Ø© (Ø³Ø§Ø¹Ø©)</option>
                            <option value="custom">ØªØ®ØµÙŠØµ Ø£ÙŠØ§Ù…</option>
                        </select>
                        <input type="number" id="m-days" class="form-control" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…" style="display:none;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" onclick="submitSave()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="replyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙ‚Ù†ÙŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="reply-text" class="form-control" rows="5" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100" onclick="sendReplySubmit()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ ğŸš€</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ================= CONFIGURATION =================
        const ADMIN_MAP = {
            "0zb8DE5GgeYobn0wMzaXiDAPbiO2": { name: "giza", label: "Eng. Giza (Owner)", role: "owner" },
            "YFYNXb6sBEPkwfikuYBBVe6ggZN2": { name: "sara", label: "Eng. Sara (Manager)", role: "manager" },
            "Zh16pJVYpwZet02RGbRPgdwFfoE2": { name: "mahmoud", label: "Eng. Mahmoud (Staff)", role: "staff" },
            "5cY88LU42yfwjlOng4ik6aADm863": { name: "ahmed", label: "Eng. Ahmed (Staff)", role: "staff" }
        };

        const SERVER_URL = "https://admey.vercel.app/api/admin"; 
        
        // Firebase Configs (From your code)
        const firebaseConfigMain = { apiKey: "AIzaSyD7PB4meIc-r2ijKzheD7P868CfKdsVej0", databaseURL: "https://full-mark1-default-rtdb.firebaseio.com" };
        const firebaseConfigTickets = { apiKey: "AIzaSyCm1yAULuM1D3ScjS9NUB2nCV_R-Y67QD4", authDomain: "reply-full.firebaseapp.com", databaseURL: "https://reply-full-default-rtdb.firebaseio.com", projectId: "reply-full", storageBucket: "reply-full.firebasestorage.app", messagingSenderId: "67591498026", appId: "1:67591498026:web:ebad8cfd2d79d3038cd653", measurementId: "G-J0WRD5YP1E" };

        // Initialize Firebase
        const mainApp = firebase.initializeApp(firebaseConfigMain); 
        const mainAuth = mainApp.auth();
        const ticketApp = firebase.initializeApp(firebaseConfigTickets, "ticketsApp");
        const ticketDB = ticketApp.database();

        // State Variables
        let currentUser = null;
        let dbData = { codes: [], blocked_devices: {}, expenses: {} };
        let currentView = 'active'; 
        let currentScope = 'all';
        let charts = {}; 
        let allTickets = [];
        let currentTicketTab = 'pending';
        let currentReplyTicketId = null;

        // UI Modals Instances
        let actionModal, replyModal;

        document.addEventListener('DOMContentLoaded', () => {
            actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
            replyModal = new bootstrap.Modal(document.getElementById('replyModal'));
        });

        // ================= AUTHENTICATION =================
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                const res = await mainAuth.signInWithEmailAndPassword(email, pass);
                if (!ADMIN_MAP[res.user.uid]) { 
                    Swal.fire('Access Denied', 'User not in admin map', 'error'); 
                    mainAuth.signOut(); 
                }
            } catch (e) { 
                Swal.fire('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error'); 
            }
        }

        mainAuth.onAuthStateChanged(user => {
            if (user && ADMIN_MAP[user.uid]) {
                currentUser = { ...ADMIN_MAP[user.uid], uid: user.uid };
                initDashboard();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });

        function logout() { mainAuth.signOut(); }

        // ================= DASHBOARD LOGIC =================
        function initDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('role-label').innerText = currentUser.label;

            if (currentUser.role === 'owner') {
                document.getElementById('stats-area').style.display = 'flex';
                document.getElementById('charts-area').style.display = 'flex';
            } else {
                currentScope = currentUser.name;
                document.getElementById('charts-area').style.display = 'none';
                document.getElementById('stats-area').style.display = 'none';
            }
            refreshData();
            if(currentUser.role === 'owner' || currentUser.role === 'manager') loadTicketsSystem();
        }

        async function refreshData() {
            try {
                const res = await fetch(`${SERVER_URL}/dashboard-data?admin_uuid=${currentUser.uid}&target_admin=${currentScope}`);
                dbData = await res.json();
                renderTable();
                updateStats(); 
                if (currentUser.role === 'owner') initCharts();
            } catch (e) { console.error(e); }
        }

        // ================= MODAL HANDLERS =================
        function openCreateModal(mode) {
            document.getElementById('modal-title').innerText = mode === 'trial' ? "Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠ" : "Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯";
            document.getElementById('edit-mode-id').value = ""; 
            document.getElementById('duration-section').style.display = 'block';
            
            document.getElementById('m-name').value = "";
            document.getElementById('m-price').value = "0";
            document.getElementById('m-duration').value = mode === 'trial' ? "trial" : "month";
            toggleCustomDays(document.getElementById('m-duration').value);
            
            actionModal.show();
        }

        function openEditModal(code) {
            const item = dbData.codes.find(c => c.code === code);
            if (!item) return Swal.fire('Error', "Student not found locally.", 'error');
            
            document.getElementById('modal-title').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª: " + item.name;
            document.getElementById('edit-mode-id').value = code;
            
            document.getElementById('m-name').value = item.name;
            document.getElementById('m-section').value = item.section || "Ø¹Ø§Ù…";
            document.getElementById('m-price').value = item.pricePaid || item.price || 0;
            document.getElementById('duration-section').style.display = 'none';
            
            actionModal.show();
        }

        async function submitSave() {
            const editId = document.getElementById('edit-mode-id').value;
            const nameVal = document.getElementById('m-name').value;
            const sectionVal = document.getElementById('m-section').value;
            const priceVal = document.getElementById('m-price').value;

            if(!nameVal) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', "Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨!", 'warning');

            const payload = {
                admin_uuid: currentUser.uid,
                name: nameVal, student_name: nameVal, studentName: nameVal,
                section: sectionVal,
                price: parseFloat(priceVal) || 0, pricePaid: parseFloat(priceVal) || 0, amount: parseFloat(priceVal) || 0
            };

            Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', didOpen: () => Swal.showLoading()});

            try {
                if (editId && editId !== "") {
                    // Update
                    payload.code = editId;
                    payload.action = 'update_student'; 
                    const res = await fetch(`${SERVER_URL}/take-action`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    if (res.ok) { 
                        Swal.fire('ØªÙ…', 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­', 'success').then(() => {
                            actionModal.hide();
                            refreshData(); // No need to reload page
                        });
                    } else { throw new Error("Server rejected update"); }
                } else {
                    // Create
                    payload.duration_type = document.getElementById('m-duration').value;
                    payload.custom_days = parseInt(document.getElementById('m-days').value) || 0;
                    const res = await fetch(`${SERVER_URL}/create-code`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    const data = await res.json();
                    
                    if(data.code) {
                        actionModal.hide();
                        // Show the generated code nicely
                        Swal.fire({
                            title: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯',
                            html: `<h2 class="text-success font-mono">${data.code}</h2>`,
                            icon: 'success',
                            confirmButtonText: 'Ù†Ø³Ø® ÙˆØ¥ØºÙ„Ø§Ù‚'
                        }).then(() => copyText(data.code));
                        refreshData();
                    } else { throw new Error(data.message); }
                }
            } catch (e) { 
                Swal.fire('Ø®Ø·Ø£', e.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        }

        // ================= CHARTS =================
        function initCharts() {
            const ctx1 = document.getElementById('usersChart').getContext('2d');
            const ctx2 = document.getElementById('financeChart').getContext('2d');
            
            const active = dbData.codes.filter(c => c.state === 'active' && !c.isTrial).length;
            const trial = dbData.codes.filter(c => c.isTrial).length;
            const expired = dbData.codes.filter(c => c.state === 'expired').length;
            const revenue = dbData.codes.reduce((a, c) => a + (parseFloat(c.pricePaid) || 0), 0);
            
            if (charts.users) charts.users.destroy();
            if (charts.finance) charts.finance.destroy();

            Chart.defaults.color = '#a0a0a0';
            Chart.defaults.borderColor = '#333';

            charts.users = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Ù†Ø´Ø·', 'ØªØ¬Ø±ÙŠØ¨ÙŠ', 'Ù…Ù†ØªÙ‡ÙŠ'],
                    datasets: [{
                        data: [active, trial, expired],
                        backgroundColor: ['#03dac6', '#bb86fc', '#cf6679'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: {position:'bottom'} } }
            });

            charts.finance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ', 'Ø§Ù„Ù…ØªÙˆÙ‚Ø¹'],
                    datasets: [{
                        label: 'Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ',
                        data: [revenue, revenue * 1.2],
                        backgroundColor: ['#bb86fc', '#333'],
                        borderRadius: 5
                    }]
                },
                options: { responsive: true }
            });
        }

        // ================= TABLES =================
        function renderTable() {
            const head = document.getElementById('table-head');
            const body = document.getElementById('table-body');
            body.innerHTML = '';

            if (currentView === 'banned') { renderBannedView(); return; }
            
            head.innerHTML = `<tr>
                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                <th>Ø§Ù„Ù…Ø¯Ø©</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>ØªØ­ÙƒÙ…</th>
            </tr>`;

            let list = currentView === 'trial' ? dbData.codes.filter(c => c.isTrial) : dbData.codes.filter(c => c.state === currentView);
            if (currentUser.role !== 'owner') list = list.filter(c => c.addedByAdmin === currentUser.name);

            list.forEach(item => {
                const badge = item.isTrial ? '<span class="badge bg-warning text-dark me-1">ØªØ¬Ø±ÙŠØ¨ÙŠ</span>' : '';
                const deviceDisplay = item.deviceId 
                    ? `<span class="badge bg-secondary font-mono">${item.deviceId.substring(0,8)}...</span>` 
                    : `<span class="text-muted">--</span>`;

                const row = `
                    <tr>
                        <td class="font-mono text-info fw-bold">${item.code}</td>
                        <td>${badge} ${item.name} <div class="small text-muted">${item.section}</div></td>
                        <td>${deviceDisplay}</td>
                        <td>${item.addedByAdmin}</td>
                        <td>${formatDuration(item)}</td>
                        <td class="text-success fw-bold">${item.pricePaid || item.price || 0}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-light" onclick="copyText('${item.code}')" title="Ù†Ø³Ø®"><i class="fas fa-copy"></i></button>
                                <button class="btn btn-outline-warning" onclick="quickAction('${item.code}', 'eject_device')" title="Ø·Ø±Ø¯"><i class="fas fa-sign-out-alt"></i></button>
                                <button class="btn btn-outline-danger" onclick="quickAction('${item.code}', 'toggle_block')" title="Ø­Ø¸Ø±"><i class="fas fa-ban"></i></button>
                                <button class="btn btn-outline-info" onclick="openEditModal('${item.code}')" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-outline-secondary" onclick="quickAction('${item.code}', 'delete')" title="Ø­Ø°Ù"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
                body.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderBannedView() {
            const body = document.getElementById('table-body');
            document.getElementById('table-head').innerHTML = `<tr><th>Device ID</th><th>Ø¨ÙˆØ§Ø³Ø·Ø©</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</th></tr>`;
            Object.values(dbData.blocked_devices || {}).forEach(d => {
                body.innerHTML += `<tr>
                    <td class="text-danger font-mono">${d.deviceId}</td>
                    <td>${d.blockedBy}</td>
                    <td>${d.reason}</td>
                    <td><button class="btn btn-sm btn-primary" onclick="unbanDevice('${d.deviceId}')">Unban</button></td>
                </tr>`;
            });
        }

        // ================= TICKETS =================
        function loadTicketsSystem() {
            ticketDB.ref('support_tickets').on('value', (snapshot) => {
                const data = snapshot.val();
                allTickets = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })).sort((a, b) => b.timestamp - a.timestamp) : [];
                updateTicketStats();
                if(document.getElementById('tickets-view').style.display !== 'none') renderTicketsGrid();
            });
        }

        function updateTicketStats() {
            document.getElementById('count-pending').innerText = allTickets.filter(t => !t.isReplied).length;
            document.getElementById('count-replied').innerText = allTickets.filter(t => t.isReplied).length;
        }

        function switchTicketTab(tab) {
            currentTicketTab = tab;
            renderTicketsGrid();
        }

        function renderTicketsGrid() {
            const container = document.getElementById('tickets-container');
            container.innerHTML = '';
            const filtered = allTickets.filter(t => currentTicketTab === 'pending' ? !t.isReplied : t.isReplied);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted py-5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</div>`;
                return;
            }

            filtered.forEach(ticket => {
                const date = new Date(ticket.timestamp).toLocaleString('en-GB');
                const card = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between text-muted small">
                                <span>#${ticket.id.substr(-6)}</span>
                                <span>${date}</span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title text-info">${ticket.subject}</h5>
                                <p class="card-text bg-dark p-2 rounded text-light small">${ticket.message}</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <small class="text-secondary"><i class="fas fa-user"></i> ${ticket.studentName}</small>
                                    <small class="font-mono bg-dark px-2 rounded">${ticket.studentCode}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent border-top-0">
                                ${ticket.isReplied ? 
                                    `<div class="alert alert-success py-2 mb-2"><small>Ø§Ù„Ø±Ø¯: ${ticket.adminReply}</small></div>
                                     <button onclick="deleteReplyOnly('${ticket.id}')" class="btn btn-outline-danger btn-sm w-100">Ø­Ø°Ù Ø§Ù„Ø±Ø¯</button>` : 
                                    `<button onclick="openReplyModal('${ticket.id}')" class="btn btn-primary btn-sm w-100">Ø±Ø¯ Ø§Ù„Ø¢Ù†</button>`
                                }
                            </div>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', card);
            });
        }

        function openReplyModal(id) {
            currentReplyTicketId = id;
            document.getElementById('reply-text').value = '';
            replyModal.show();
        }

        function sendReplySubmit() {
            const text = document.getElementById('reply-text').value;
            if (!text) return;
            ticketDB.ref('support_tickets/' + currentReplyTicketId).update({
                isReplied: true, adminReply: text, replyDate: firebase.database.ServerValue.TIMESTAMP
            });
            replyModal.hide();
            Swal.fire('ØªÙ…', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function deleteReplyOnly(id) {
            Swal.fire({
                title: 'Ø­Ø°Ù Ø§Ù„Ø±Ø¯ØŸ', text: "Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±", icon: 'warning', showCancelButton: true
            }).then((result) => {
                if(result.isConfirmed) ticketDB.ref('support_tickets/' + id).update({ isReplied: false, adminReply: null });
            });
        }

        // ================= UTILS & HELPERS =================
        function switchMainTab(tab, btn) {
            document.querySelectorAll('.nav-pills .nav-link').forEach(t => t.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            ['dashboard-view', 'tickets-view', 'team-view'].forEach(id => document.getElementById(id).style.display = 'none');
            
            if(tab === 'dashboard') document.getElementById('dashboard-view').style.display = 'block';
            if(tab === 'tickets') { document.getElementById('tickets-view').style.display = 'block'; renderTicketsGrid(); }
            if(tab === 'team') {
                document.getElementById('team-view').style.display = 'block';
                const teamHTML = Object.values(ADMIN_MAP).map(a => `
                    <div class="col-md-3">
                        <div class="card text-center p-4">
                            <i class="fas fa-user-shield fa-3x text-secondary mb-3"></i>
                            <h5 class="text-white">${a.label}</h5>
                            <span class="badge bg-dark border border-secondary">${a.role.toUpperCase()}</span>
                        </div>
                    </div>`).join('');
                document.getElementById('team-grid').innerHTML = teamHTML;
            }
        }

        function updateStats() {
            const area = document.getElementById('stats-area');
            if(currentUser.role !== 'owner') return;
            area.innerHTML = `
                <div class="col-6 col-md-3"><div class="card p-3"><h3 class="text-info">${dbData.codes.length}</h3><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</small></div></div>
                <div class="col-6 col-md-3"><div class="card p-3"><h3 class="text-success">${dbData.codes.filter(c=>c.state==='active').length}</h3><small>Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹</small></div></div>
            `;
        }

        async function quickAction(code, action) {
            const result = await Swal.fire({title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…', cancelButtonText: 'Ù„Ø§'});
            if (!result.isConfirmed) return;
            
            await fetch(`${SERVER_URL}/take-action`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code, action, admin_uuid: currentUser.uid }) });
            refreshData();
            Swal.fire('ØªÙ…', 'ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', 'success');
        }

        async function unbanDevice(id) {
            await fetch(`${SERVER_URL}/take-action`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code: id, action: 'unban_device', admin_uuid: currentUser.uid }) });
            refreshData();
            Swal.fire('ØªÙ…', 'ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²', 'success');
        }

        function formatDuration(item) {
            if (item.state !== 'active') return `<span class="badge bg-danger">EXPIRED</span>`;
            const rem = item.expiry - Date.now();
            if (rem <= 0) return `<span class="badge bg-danger">EXPIRED</span>`;
            if (item.isTrial) {
                const min = Math.floor(rem/60000);
                return min < 60 ? `<span class="badge bg-warning text-dark">${min} MIN</span>` : `<span class="badge bg-warning text-dark">${Math.floor(min/60)} HR</span>`;
            }
            return `<span class="text-white">${Math.ceil(rem / 86400000)} ÙŠÙˆÙ…</span>`;
        }

        function filterTable() {
            const val = document.getElementById("searchInput").value.toLowerCase();
            document.querySelectorAll("#table-body tr").forEach(row => { row.style.display = row.innerText.toLowerCase().includes(val) ? "" : "none"; });
        }
        
        function copyText(t) { 
            if(t) {
                navigator.clipboard.writeText(t);
                Swal.fire({toast: true, position: 'top-end', icon: 'success', title: 'ØªÙ… Ø§Ù„Ù†Ø³Ø®', showConfirmButton: false, timer: 1500});
            }
        }
        
        function toggleCustomDays(v) { document.getElementById('m-days').style.display = v === 'custom' ? 'block' : 'none'; }
        
        function setView(v, b) { 
            currentView = v; 
            document.querySelectorAll('.sub-nav-btn').forEach(btn => btn.classList.remove('active')); 
            b.classList.add('active'); 
            renderTable(); 
        }
    </script>
</body>
</html>
