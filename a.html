<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIZA ELITE | Cyber Support Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #020b14; --card-bg: #051322; --accent: #00f2ff;
            --green-neon: #00F5C4; --danger: #ff4757; --text: #e0f7fa; --border: #0a2540;
        }

        body { background-color: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; margin: 0; height: 100vh; display: flex; overflow: hidden; }

        .sidebar { width: 350px; background: var(--card-bg); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); background: rgba(0, 242, 255, 0.05); }
        .search-box { width: 100%; padding: 10px; background: #02080e; border: 1px solid var(--border); color: white; border-radius: 8px; margin-top: 10px; }
        .students-list { flex: 1; overflow-y: auto; }
        .student-item { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.02); cursor: pointer; position: relative; transition: 0.3s; }
        .student-item:hover { background: rgba(0, 242, 255, 0.05); }
        .student-item.active { background: rgba(0, 242, 255, 0.1); border-right: 4px solid var(--accent); }

        .unread-dot { width: 10px; height: 10px; background: var(--danger); border-radius: 50%; position: absolute; left: 20px; top: 50%; transform: translateY(-50%); box-shadow: 0 0 10px var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.3); } 100% { transform: translateY(-50%) scale(1); } }

        .chat-main { flex: 1; display: flex; flex-direction: column; background: radial-gradient(circle at center, #0a1f35 0%, #020b14 100%); }
        .chat-header { padding: 15px 30px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .msg-bubble { max-width: 70%; padding: 12px 18px; border-radius: 15px; position: relative; cursor: pointer; }
        .msg-student { align-self: flex-start; background: #0a2540; border-bottom-right-radius: 2px; border: 1px solid rgba(0, 242, 255, 0.2); }
        .msg-admin { align-self: flex-end; background: var(--green-neon); color: #000; border-bottom-left-radius: 2px; font-weight: 600; }
        .msg-time { font-size: 0.6rem; opacity: 0.5; margin-top: 5px; display: block; }
        
        .reply-preview { background: rgba(0, 242, 255, 0.1); padding: 5px 10px; border-radius: 5px; border-right: 3px solid var(--accent); margin-bottom: 5px; font-size: 0.8rem; display: none; justify-content: space-between; }

        .chat-input-area { padding: 20px; background: var(--card-bg); border-top: 1px solid var(--border); }
        .input-wrapper { display: flex; gap: 10px; }
        textarea { flex: 1; background: #02080e; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; resize: none; height: 45px; }
        .send-btn { background: var(--accent); color: #000; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 15px; border: 1px solid var(--accent); width: 400px; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #02080e; border: 1px solid var(--border); color: white; border-radius: 5px; }

        .btn-plus { background: var(--accent); color: #000; width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; float: left; }
    </style>
</head>
<body>

    <div id="newMsgModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--accent)">رسالة جديدة لطالب</h3>
            <input type="text" id="targetCode" placeholder="كود الطالب">
            <input type="text" id="targetName" placeholder="اسم الطالب (اختياري)">
            <textarea id="targetMsg" style="width:100%; height:80px" placeholder="نص الرسالة..."></textarea>
            <div style="display:flex; gap:10px; margin-top:15px">
                <button class="send-btn" style="flex:1" onclick="createNewTicket()">إرسال</button>
                <button class="send-btn" style="background:var(--danger); color:white" onclick="closeModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <button class="btn-plus" onclick="openNewMsgModal()"><i class="fas fa-plus"></i></button>
            <h3 style="margin:0; text-align: center; color:var(--accent)">المحادثات</h3>
            <input type="text" class="search-box" id="searchStudent" placeholder="بحث..." onkeyup="filterStudents()">
        </div>
        <div class="students-list" id="studentsList"></div>
    </div>

    <div class="chat-main">
        <div id="no-chat" style="margin:auto; text-align:center; opacity:0.3;">
            <i class="fas fa-robot fa-5x"></i>
            <p>سارة، اختاري طالب أو ابدأي شات جديد</p>
        </div>

        <div id="chat-active" style="display:none; flex-direction:column; height:100%;">
            <div class="chat-header">
                <div>
                    <h4 id="active-student-name" style="margin:0">اسم الطالب</h4>
                    <small id="active-student-code" style="color:var(--accent)"></small>
                </div>
                <button class="send-btn" style="background:var(--danger); color:white; padding:5px 15px;" onclick="deleteCurrentThread()">حذف الكل</button>
            </div>

            <div class="messages-container" id="messagesBox"></div>

            <div class="chat-input-area">
                <div id="reply-preview" class="reply-preview">
                    <span id="reply-text-val"></span>
                    <i class="fas fa-times" onclick="cancelReplyTo()" style="cursor:pointer"></i>
                </div>
                <div class="input-wrapper">
                    <textarea id="replyText" placeholder="اكتب ردك هنا..."></textarea>
                    <button class="send-btn" id="sendBtn" onclick="handleSend()">إرسال</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfigTickets = {
            apiKey: "AIzaSyCm1yAULuM1D3ScjS9NUB2nCV_R-Y67QD4",
            databaseURL: "https://reply-full-default-rtdb.firebaseio.com",
        };
        const app = firebase.initializeApp(firebaseConfigTickets);
        const db = app.database();

        let allData = {};
        let selectedStudentCode = null;
        let replyingToId = null;

        db.ref('support_tickets').on('value', (snapshot) => {
            allData = snapshot.val() || {};
            renderStudentsList();
            if (selectedStudentCode) renderMessages();
        });

        function renderStudentsList() {
            const list = document.getElementById('studentsList');
            list.innerHTML = '';
            const groups = {};
            Object.keys(allData).forEach(id => {
                const msg = allData[id];
                if (!groups[msg.studentCode]) {
                    groups[msg.studentCode] = { name: msg.studentName, code: msg.studentCode, time: 0, unread: false };
                }
                if (msg.timestamp > groups[msg.studentCode].time) groups[msg.studentCode].time = msg.timestamp;
                
                // التعديل هنا: النقطة الحمراء تظهر لو seen مش موجودة أو false
                if (msg.seen !== true) groups[msg.studentCode].unread = true;
            });

            Object.values(groups).sort((a,b)=>b.time-a.time).forEach(s => {
                const div = document.createElement('div');
                div.className = `student-item ${selectedStudentCode === s.code ? 'active' : ''}`;
                div.onclick = () => selectStudent(s.code, s.name);
                div.innerHTML = `<div>${s.name || 'مجهول'}</div><small style="color:#888">${s.code}</small>${s.unread ? '<div class="unread-dot"></div>' : ''}`;
                list.appendChild(div);
            });
        }

        async function selectStudent(code, name) {
            selectedStudentCode = code;
            document.getElementById('no-chat').style.display = 'none';
            document.getElementById('chat-active').style.display = 'flex';
            document.getElementById('active-student-name').innerText = name;
            document.getElementById('active-student-code').innerText = code;
            
            // Seen System: هنا بنحدث الـ seen بس عشان النقطة تختفي من غير ما نبعت رد للطالب
            const targets = Object.keys(allData).filter(id => allData[id].studentCode === code && allData[id].seen !== true);
            for (let id of targets) {
                db.ref('support_tickets/' + id).update({ seen: true });
            }
            renderMessages();
        }

        function renderMessages() {
            const box = document.getElementById('messagesBox');
            box.innerHTML = '';
            const msgs = Object.keys(allData).map(id=>({id, ...allData[id]})).filter(m=>m.studentCode === selectedStudentCode).sort((a,b)=>a.timestamp-b.timestamp);
            
            msgs.forEach(m => {
                box.innerHTML += `<div class="msg-bubble msg-student" onclick="setReplyTo('${m.id}', '${m.message}')">
                    <small style="color:var(--accent)">${m.subject}</small><div>${m.message}</div>
                    <span class="msg-time">${new Date(m.timestamp).toLocaleTimeString('ar-EG')}</span>
                </div>`;
                
                // التعديل هنا: الرد بيفضل يظهر بس لو أنتِ رديتي فعلاً (isReplied: true)
                if (m.isReplied === true && m.adminReply) {
                    box.innerHTML += `<div class="msg-bubble msg-admin"><div>${m.adminReply}</div>
                    <span class="msg-time">${m.replyDate ? new Date(m.replyDate).toLocaleTimeString('ar-EG') : ''}</span></div>`;
                }
            });
            box.scrollTop = box.scrollHeight;
        }

        function setReplyTo(id, text) {
            replyingToId = id;
            document.getElementById('reply-preview').style.display = 'flex';
            document.getElementById('reply-text-val').innerText = "الرد على: " + text.substring(0, 30) + "...";
        }

        function cancelReplyTo() { replyingToId = null; document.getElementById('reply-preview').style.display = 'none'; }

        async function handleSend() {
            const text = document.getElementById('replyText').value;
            if (!text) return;
            
            let targetId = replyingToId;
            if (!targetId) {
                const pending = Object.keys(allData).map(id=>({id, ...allData[id]})).filter(m=>m.studentCode===selectedStudentCode).sort((a,b)=>b.timestamp-a.timestamp);
                if (pending.length > 0) targetId = pending[0].id;
            }

            if (targetId) {
                // هنا بقى لما سارة تدوس إرسال، بنخلي isReplied: true والرد يظهر
                await db.ref('support_tickets/' + targetId).update({
                    isReplied: true, 
                    adminReply: text, 
                    replyDate: firebase.database.ServerValue.TIMESTAMP,
                    seen: true 
                });
                document.getElementById('replyText').value = '';
                cancelReplyTo();
            }
        }

        function openNewMsgModal() { document.getElementById('newMsgModal').style.display = 'flex'; }
        function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }

        async function createNewTicket() {
            const code = document.getElementById('targetCode').value;
            const msg = document.getElementById('targetMsg').value;
            const name = document.getElementById('targetName').value || "طالب";
            if (!code || !msg) return alert("كمل البيانات");

            const newId = db.ref('support_tickets').push().key;
            await db.ref('support_tickets/' + newId).set({
                studentCode: code, studentName: name, message: "(رسالة من الإدارة): " + msg,
                subject: "ADMIN_MSG", timestamp: firebase.database.ServerValue.TIMESTAMP, 
                isReplied: false,
                seen: true // عشان رسائل الإدارة متعملش نقطة حمراء عندك أنتِ
            });
            closeModal();
            selectStudent(code, name);
        }

        function deleteCurrentThread() {
            if(confirm("مسح الشات كله؟")) {
                Object.keys(allData).filter(id=>allData[id].studentCode===selectedStudentCode).forEach(id=>db.ref('support_tickets/'+id).remove());
                location.reload();
            }
        }

        function filterStudents() {
            const v = document.getElementById('searchStudent').value.toLowerCase();
            document.querySelectorAll('.student-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(v) ? 'block' : 'none');
        }
    </script>
</body>
</html>
